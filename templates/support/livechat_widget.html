{% load static %}
{% if user.is_authenticated %}
<div id="livechat-fab" style="position:fixed;bottom:85px;right:25px;z-index:9999;width:62px;height:62px;background:#b71749;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.35);transition:all .25s;">
  <svg width="34" height="34" viewBox="0 0 24 24" fill="#fff" xmlns="http://www.w3.org/2000/svg"><path d="M2 3h20v14H6l-4 4V3zm4 6v2h12V9H6zm0-4v2h12V5H6z"/></svg>
</div>
<div id="livechat-panel" style="display:none;position:fixed;bottom:20px;right:20px;width:360px;max-width:94%;height:520px;background:#fff;border-radius:18px;box-shadow:0 10px 25px rgba(0,0,0,.35);overflow:hidden;z-index:10000;direction:rtl;font-family:inherit;">
  <div style="background:#b71749;color:#fff;padding:12px 14px;display:flex;align-items:center;justify-content:space-between;">
    <div style="font-weight:600;font-size:15px;">پشتیبانی آنلاین بیدرا</div>
    <button id="livechat-close" style="background:rgba(255,255,255,.15);border:0;color:#fff;width:32px;height:32px;border-radius:50%;font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer;">×</button>
  </div>
  <div id="livechat-body" style="display:flex;flex-direction:column;height:calc(100% - 54px);">
    <div id="livechat-select-dept" style="padding:14px;">
      <label style="font-size:13px;margin-bottom:6px;display:block;">انتخاب دپارتمان</label>
      <select id="livechat-dept" class="form-control form-select" style="font-size:13px;"></select>
      <button id="livechat-start" class="btn btn-sm btn-primary mt-2" style="font-size:13px;">شروع گفتگو</button>
    </div>
    <div id="livechat-messages-wrap" style="flex:1;display:none;padding:10px 12px;background:#f9f9fb;overflow-y:auto;">
      <div id="livechat-messages" style="display:flex;flex-direction:column;gap:8px;"></div>
    </div>
    <form id="livechat-form" style="display:none;padding:6px 8px;border-top:1px solid #e3e3e8;background:#fff;">
      <div class="input-group">
        <textarea id="livechat-input" placeholder="پیام خود را بنویسید..." class="form-control" rows="1" style="resize:none;max-height:120px;font-size:13px;"></textarea>
        <button id="livechat-send" class="btn btn-success" type="submit" style="font-size:13px;">ارسال</button>
      </div>
    </form>
  </div>
</div>
<script>
(function(){
  const fab=document.getElementById('livechat-fab');
  const panel=document.getElementById('livechat-panel');
  const closeBtn=document.getElementById('livechat-close');
  const deptSelect=document.getElementById('livechat-dept');
  const startBtn=document.getElementById('livechat-start');
  const selectBox=document.getElementById('livechat-select-dept');
  const messagesWrap=document.getElementById('livechat-messages-wrap');
  const messagesBox=document.getElementById('livechat-messages');
  const form=document.getElementById('livechat-form');
  const input=document.getElementById('livechat-input');
  let sessionId=null; let lastTimestamp=null; let pollTimer=null;
  function openPanel(){panel.style.display='block';fab.style.transform='scale(0)';}
  function closePanel(){panel.style.display='none';fab.style.transform='scale(1)';}
  fab.addEventListener('click',openPanel);closeBtn.addEventListener('click',closePanel);
  // load departments
  fetch('{% url "support:livechat_departments" %}').then(r=>r.json()).then(d=>{if(d.ok){deptSelect.innerHTML=d.departments.map(o=>`<option value="${o.id}">${o.name}</option>`).join('');}});
  startBtn.addEventListener('click',()=>{
    const fd=new FormData();fd.append('department',deptSelect.value);fd.append('csrfmiddlewaretoken','{{ csrf_token }}');
    fetch('{% url "support:livechat_start" %}',{method:'POST',body:fd,headers:{'X-Requested-With':'XMLHttpRequest'}})
      .then(r=>r.json()).then(d=>{if(d.ok){sessionId=d.session_id;selectBox.style.display='none';messagesWrap.style.display='block';form.style.display='block';startPolling();}})
  });
  function addMessage(m){
    const div=document.createElement('div');
    div.style.maxWidth='85%';
    div.style.alignSelf=m.is_supporter?'flex-start':'flex-end';
    div.innerHTML=`<div style="background:${m.is_supporter?'#fff':'#daf7e9'};border:1px solid #e0e3e8;padding:8px 10px;border-radius:14px;font-size:13px;line-height:1.5;">${m.message.replace(/</g,'&lt;')}</div><div style="font-size:10px;color:#888;margin:${m.is_supporter?'2px 4px 0 0':'2px 0 0 4px'};text-align:${m.is_supporter?'left':'right'};">${new Date(m.created_at).toLocaleTimeString('fa-IR',{hour:'2-digit',minute:'2-digit'})}</div>`;
    messagesBox.appendChild(div);messagesWrap.scrollTop=messagesWrap.scrollHeight;lastTimestamp=m.created_at;
  }
  function fetchMessages(){if(!sessionId) return;let url=`{% url 'support:livechat_messages' 999999 %}`.replace('999999',sessionId);if(lastTimestamp) url+=`?since=${encodeURIComponent(lastTimestamp)}`;fetch(url).then(r=>r.json()).then(d=>{if(d.ok){d.messages.forEach(addMessage);}})}
  function startPolling(){if(pollTimer) clearInterval(pollTimer);fetchMessages();pollTimer=setInterval(fetchMessages,3500);} 
  form.addEventListener('submit',e=>{e.preventDefault();if(!input.value.trim()) return;const text=input.value.trim();const fd=new FormData();fd.append('message',text);fd.append('csrfmiddlewaretoken','{{ csrf_token }}');fetch(`{% url 'support:livechat_send' 999999 %}`.replace('999999',sessionId),{method:'POST',body:fd,headers:{'X-Requested-With':'XMLHttpRequest'}}).then(r=>r.json()).then(d=>{if(d.ok){/* optimistic add */addMessage({id:d.message_id,message:text,is_supporter:false,created_at:new Date().toISOString()});input.value='';input.style.height='auto';}});});
  input.addEventListener('input',()=>{input.style.height='auto';input.style.height=Math.min(input.scrollHeight,120)+'px';});
})();
</script>
{% endif %}
