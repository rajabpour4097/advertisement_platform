{% extends "account/account_base.html" %}
{% block content %}
<h3>تیکت ها</h3>
<a class="btn btn-primary" href="{% url 'support:ticket_create' %}">ارسال تیکت جدید</a>
<table class="table table-striped mt-3">
    <thead>
        <tr>
            <th>#</th>
            <th>عنوان</th>
            <th>دپارتمان</th>
            <th>موضوع</th>
            <th>وضعیت</th>
            {% if request.user.is_am or request.user.is_staff %}
                <th>پشتیبان</th>
            {% endif %}
            {% if request.user.is_am or request.user.is_staff or request.user.is_supporter %}
                <th>امتیاز</th>
            {% endif %}
            <th>آخرین پاسخ</th>
        </tr>
    </thead>
    <tbody>
        {% for t in tickets %}
        <tr>
            <td>{{ t.id }}</td>
            <td><a href="{% url 'support:ticket_detail' t.id %}">{{ t.title }}</a></td>
            <td>{{ t.department.name }}</td>
            <td>{{ t.subject.title }}</td>
            <td>{{ t.get_status_display }}</td>
            {% if request.user.is_am or request.user.is_staff %}
                <td>{{ t.supporter.get_full_name|default:'-' }}</td>
            {% endif %}
            {% if request.user.is_am or request.user.is_staff or request.user.is_supporter %}
            <td>{% if t.rating_score %}{{ t.rating_score }}{% else %}-{% endif %}</td>
            {% endif %}
            <td>
                {% if t.last_resp %}
                    {{ t.last_resp|date:'Y-m-d H:i' }}<br>
                    <span class="text-muted" style="font-size:11px;direction:rtl;display:inline-block;max-width:220px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                        {{ t.last_msg|default:''|striptags|truncatechars:70 }}
                    </span>
                {% else %}-{% endif %}
            </td>
        </tr>
        {% empty %}
        <tr><td colspan="7">موردی یافت نشد</td></tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}
