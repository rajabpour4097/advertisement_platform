{% extends "account/account_base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Ø±Ø²ÙˆÙ…Ù‡ Ù…Ù†{% endblock %}

{% block content %}
<style>
    .resume-form {
        max-width: 800px;
        margin: 0 auto;
        font-family: sans-serif;
    }

    .resume-form .form-group {
        margin-bottom: 20px;
    }

    .resume-form label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #34495e;
    }

    .resume-form input,
    .resume-form textarea,
    .resume-form select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 14px;
        box-sizing: border-box;
    }

    .resume-form .row {
        display: flex;
        gap: 20px;
    }

    .resume-form .row > div {
        flex: 1;
    }

    .resume-form button {
        background-color: #028c32;
        color: white;
        padding: 12px 25px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        margin-right: 10px;
    }

    .resume-form button:hover {
        background-color: #026a24;
    }

    .resume-status {
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 20px;
        text-align: center;
        font-weight: bold;
    }

    .status-pending {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .status-under_review {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }

    .status-needs_editing {
        background-color: #fcefe2;
        color: #856404;
        border: 1px solid #f9e79f;
    }

    .status-approved {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .status-rejected {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .manager-comment {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin: 15px 0;
        border-left: 4px solid #007bff;
    }

    .char-counter {
        font-size: 12px;
        color: #666;
        text-align: left;
        margin-top: 5px;
    }

    .char-counter.over-limit {
        color: #dc3545;
        font-weight: bold;
    }

    .empty-message {
        color: #666;
        font-style: italic;
        padding: 20px;
        text-align: center;
        background: #f8f9fa;
        border-radius: 5px;
        border: 1px dashed #dee2e6;
    }

    .custom-file-upload {
        margin-top: 5px;
    }
    
    .file-upload-btn {
        display: flex;
        border-radius: 5px;
        overflow: hidden;
        cursor: pointer;
        border: 1px solid #ccc;
    }
    
    .file-name-display {
        flex-grow: 1;
        padding: 10px 15px;
        background: white;
        color: #666;
        text-align: right;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .file-select-btn {
        padding: 10px 15px;
        background-color: #3498db;
        color: white;
        font-weight: bold;
        min-width: 110px;
        text-align: center;
    }

    .portfolio-item {
        border: 1px solid #ddd;
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
        display: flex;
        align-items: center;
    }

    .portfolio-item label {
        margin: 0;
        display: flex;
        align-items: center;
        width: 100%;
    }

    .portfolio-item input[type="checkbox"] {
        margin-left: 10px;
        width: auto;
    }

    /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ù†ÙˆØ¹ Ù…Ø¬Ø±ÛŒ */
    .dealer-type-card-list {
        display: flex;
        flex-wrap: nowrap;
        gap: 6px; /* Ú©Ø§Ù‡Ø´ gap */
        justify-content: flex-start;
    }

    .dealer-type-card {
        position: relative;
        width: calc(16.66% - 5px); /* ØªØºÛŒÛŒØ± Ø§Ø² 20% Ø¨Ù‡ 16.66% (ØªÙ‚Ø±ÛŒØ¨Ø§Ù‹ 6 Ú©Ø§Ø±Øª Ø¯Ø± Ø³Ø·Ø±) */
        border: 2px solid #ddd;
        border-radius: 6px;
        padding: 4px; /* Ú©Ø§Ù‡Ø´ padding */
        cursor: pointer;
        text-align: center;
        transition: all 0.3s ease;
        background-color: #fff;
        min-height: 50px; /* Ú©Ø§Ù‡Ø´ Ø§Ø±ØªÙØ§Ø¹ */
        display: flex;
        flex-direction: column;
        justify-content: center;
        flex-shrink: 0;
    }

    .dealer-type-card.selected {
        box-shadow: 0 0 6px rgba(2, 140, 50, 0.3);
        border-color: #028c32;
    }

    .dealer-type-card .icon-wrapper {
        width: 20px; /* Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² */
        height: 20px;
        border-radius: 3px;
        margin: 0 auto 2px; /* Ú©Ø§Ù‡Ø´ margin */
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .dealer-type-card img {
        width: 14px; /* Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² ØªØµÙˆÛŒØ± */
        height: 14px;
    }

    .dealer-type-card h5 {
        font-weight: bold;
        margin: 0;
        font-size: 10px; /* Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª */
        line-height: 1;
    }

    .dealer-type-card .checkmark {
        position: absolute;
        top: 2px;
        left: 2px;
        font-size: 10px;
        color: #028c32;
        display: none;
    }

    .dealer-type-card.selected .checkmark {
        display: block;
    }

    /* Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ */
    @media (max-width: 768px) {
        .dealer-type-card-list {
            flex-wrap: wrap; /* Ø§Ø¬Ø§Ø²Ù‡ wrap Ø´Ø¯Ù† */
            gap: 4px;
        }
        
        .dealer-type-card {
            width: calc(33.33% - 3px); /* 3 Ú©Ø§Ø±Øª Ø¯Ø± Ø³Ø·Ø± */
            min-height: 40px;
            padding: 3px;
        }
        
        .dealer-type-card h5 {
            font-size: 7px;
            line-height: 1;
        }
        
        .dealer-type-card img {
            width: 10px;
            height: 10px;
        }
        
        .dealer-type-card .icon-wrapper {
            width: 14px;
            height: 14px;
            margin-bottom: 1px;
        }
    }

    /* Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø®ÛŒÙ„ÛŒ Ú©ÙˆÚ†Ú© */
    @media (max-width: 480px) {
        .dealer-type-card {
            width: calc(50% - 2px); /* 2 Ú©Ø§Ø±Øª Ø¯Ø± Ø³Ø·Ø± */
        }
        
        .dealer-type-card h5 {
            font-size: 8px;
        }
    }
</style>

<div class="container-fluid">
    <div class="x_panel">
        <div class="x_title">
            <h2>Ø±Ø²ÙˆÙ…Ù‡ Ù…Ù†</h2>
            <div class="clearfix"></div>
        </div>

        <div class="x_content">
            {% if resume %}
                <div class="resume-status 
                    {% if resume.status == 'pending' %}status-pending
                    {% elif resume.status == 'under_review' %}status-under_review
                    {% elif resume.status == 'needs_editing' %}status-needs_editing
                    {% elif resume.status == 'approved' %}status-approved
                    {% elif resume.status == 'rejected' %}status-rejected
                    {% endif %}">
                    
                    ÙˆØ¶Ø¹ÛŒØª Ø±Ø²ÙˆÙ…Ù‡: {{ resume.get_status_display }}
                    
                    {% if resume.status == 'needs_editing' %}
                        <br><small>Ù„Ø·ÙØ§Ù‹ Ø±Ø²ÙˆÙ…Ù‡ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø¸Ø±Ø§Øª Ù…Ø¯ÛŒØ± ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù†ÛŒØ¯.</small>
                    {% elif resume.status == 'rejected' %}
                        <br><small>Ø±Ø²ÙˆÙ…Ù‡ Ø´Ù…Ø§ Ø±Ø¯ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø±Ø²ÙˆÙ…Ù‡ Ø¬Ø¯ÛŒØ¯ÛŒ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.</small>
                    {% elif resume.status == 'approved' %}
                        <br><small>Ø±Ø²ÙˆÙ…Ù‡ Ø´Ù…Ø§ ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡ Ùˆ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¯Ø± Ú©Ù…Ù¾ÛŒÙ†â€ŒÙ‡Ø§ Ø´Ø±Ú©Øª Ú©Ù†ÛŒØ¯.</small>
                    {% endif %}
                </div>

                {% if resume.manager_comment %}
                    <div class="manager-comment">
                        <strong>Ù†Ø¸Ø± Ù…Ø¯ÛŒØ±:</strong>
                        <p>{{ resume.manager_comment|linebreaksbr }}</p>
                    </div>
                {% endif %}
            {% endif %}

            <form method="post" enctype="multipart/form-data" class="resume-form" id="resume-form">
                {% csrf_token %}

                <!-- Ù†ÙˆØ¹ Ù…Ø¬Ø±ÛŒ ØªØ¨Ù„ÛŒØºØ§Øª Ø¨Ø§ Ú©Ø§Ø±Øª -->
                <div class="form-group">
                    <label>Ù†ÙˆØ¹ Ù…Ø¬Ø±ÛŒ ØªØ¨Ù„ÛŒØºØ§Øª *</label>
                    <div class="dealer-type-card-list">
                        {% for topic in parent_topics %}
                            <div class="dealer-type-card {% if form.dealer_type.value == topic.id %}selected{% endif %}" 
                                 data-id="{{ topic.id }}" 
                                 data-color="{{ topic.color|default:'#028c32' }}">
                                {% if topic.icon %}
                                    <div class="icon-wrapper">
                                        <img src="{{ topic.icon.url }}" alt="{{ topic.name }}" />
                                    </div>
                                {% endif %}
                                <h5>{{ topic.name }}</h5>
                                <div class="checkmark">âœ”</div>
                            </div>
                        {% endfor %}
                    </div>
                    <input type="hidden" name="dealer_type" id="selected-dealer-type-id" value="{{ form.dealer_type.value }}">
                </div>

                <!-- Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ ØªØ®ØµØµÛŒ Ø¨Ø§ radio -->
                <div class="form-group">
                    <label>Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ ØªØ®ØµØµÛŒ</label>
                    <div id="specialty-categories-container">
                        <div class="empty-message">
                            Ø§Ø¨ØªØ¯Ø§ Ù†ÙˆØ¹ Ù…Ø¬Ø±ÛŒ ØªØ¨Ù„ÛŒØºØ§Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.
                        </div>
                    </div>
                </div>

                <!-- Ø¨Ø®Ø´ Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø³ØªØ§Ù† Ùˆ Ø´Ù‡Ø±Ù‡Ø§ -->
                <div class="form-group">
                    <label>Ø­ÙˆØ²Ù‡ Ø®Ø¯Ù…Ø§Øª (Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§ Ùˆ Ø´Ù‡Ø±Ù‡Ø§)</label>
                    <button type="button" id="open-city-modal" style="width: 20%; font-size: 12px; background-color: #86a7c9ff;">
                        Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø³ØªØ§Ù† Ùˆ Ø´Ù‡Ø±
                    </button>
                    <div id="selected-cities-summary" style="margin-top:10px;"></div>
                    <!-- Ø§ÛŒÙ† input Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø§Ø¯Ù‡ Ø¨Ù‡ Ø³Ø±ÙˆØ± -->
                    <input type="hidden" name="service_area" id="service_area_input">
                </div>

                <div>
                    <label for="id_describe">Ù…Ø¹Ø±ÙÛŒ Ù…Ø®ØªØµØ± Ø§Ø² Ø®ÙˆØ¯ (Ø­Ø¯Ø§Ú©Ø«Ø± 250 Ú©Ø§Ø±Ø§Ú©ØªØ±) *</label>
                    <textarea name="describe" id="id_describe" class="form-control" rows="3" 
                              maxlength="250" required>{{ form.describe.value|default:'' }}</textarea>
                    <div class="char-counter" id="describe-counter">0/250</div>
                </div>

                <div>
                    <label for="id_services">Ø®Ø¯Ù…Ø§Øª Ù‚Ø§Ø¨Ù„ Ø§Ø±Ø§Ø¦Ù‡ (Ø­Ø¯Ø§Ú©Ø«Ø± 120 Ú©Ø§Ø±Ø§Ú©ØªØ±) *</label>
                    <textarea name="services" id="id_services" class="form-control" 
                            rows="2" placeholder="Ù…Ø§Ù†Ù†Ø¯ 'Ø·Ø±Ø§Ø­ÛŒ Ú¯Ø±Ø§ÙÛŒÚ©ÛŒØŒ Ø§Ø¬Ø±Ø§ÛŒ Ø¨ÛŒÙ„Ø¨ÙˆØ±Ø¯ØŒ ØªØ¯ÙˆÛŒÙ† ÙˆÛŒØ¯ÛŒÙˆØŒ Ø§Ø³Ù¾Ø§Ù†Ø³Ø±Ø´ÛŒÙ¾ Ø§ÛŒÙˆÙ†Øª'"
                              maxlength="120" required>{{ form.services.value|default:'' }}</textarea>
                    <div class="char-counter" id="services-counter">0/120</div>
                </div>

                <div class="row">
                    <div>
                        <label for="id_socialmedia_and_sites">Ø´Ø¨Ú©Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ Ùˆ ÙˆØ¨â€ŒØ³Ø§ÛŒØªâ€ŒÙ‡Ø§ (Ø­Ø¯Ø§Ú©Ø«Ø± 120 Ú©Ø§Ø±Ø§Ú©ØªØ±)</label>
                        <textarea name="socialmedia_and_sites" id="id_socialmedia_and_sites" 
                                placeholder="Ù…Ø§Ù†Ù†Ø¯ 'Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…ØŒ Ù„ÛŒÙ†Ú©Ø¯ÛŒÙ†ØŒ ÙˆØ¨â€ŒØ³Ø§ÛŒØª Ø´Ø®ØµÛŒ'"
                                class="form-control" rows="2" maxlength="120">{{ form.socialmedia_and_sites.value|default:'' }}</textarea>
                        <div class="char-counter" id="socialmedia-counter">0/120</div>
                    </div>
                    <div>
                        <label for="id_tools_and_platforms">Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ Ùˆ Ù¾Ù„ØªÙØ±Ù…â€ŒÙ‡Ø§ (Ø­Ø¯Ø§Ú©Ø«Ø± 120 Ú©Ø§Ø±Ø§Ú©ØªØ±)</label>
                        <textarea name="tools_and_platforms" id="id_tools_and_platforms" 
                                placeholder="Ù…Ø§Ù†Ù†Ø¯ 'ÙØªÙˆØ´Ø§Ù¾ØŒ Ø§ÛŒÙ„Ø§Ø³ØªØ±ÛŒØªÙˆØ±ØŒ Ù¾Ø±ÛŒÙ…ÛŒØ±'"
                                class="form-control" rows="2" maxlength="120">{{ form.tools_and_platforms.value|default:'' }}</textarea>
                        <div class="char-counter" id="tools-counter">0/120</div>
                    </div>
                </div>

                <!-- Ø¨Ø®Ø´ Ù¾ÙˆØ±ØªÙÙˆÙ„ÛŒÙˆÙ‡Ø§ -->
                <div class="form-group">
                    <label> Ù†Ù…ÙˆÙ†Ù‡ Ú©Ø§Ø±Ù‡Ø§</label>
                    <button type="button" id="open-portfolio-modal" class="btn btn-outline-primary" 
                            style="width: 20%; font-size: 12px; background-color: #86a7c9ff;">
                        Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù…ÙˆÙ†Ù‡ Ú©Ø§Ø±
                    </button>
                    <div id="selected-portfolios-summary" style="margin-top:10px;"></div>
                    <input type="hidden" name="portfolios" id="portfolios_input">
                </div>

                <div class="row">
                    <div>
                        <label for="id_partner_brand">Ø¨Ø±Ù†Ø¯Ù‡Ø§ÛŒ Ù‡Ù…Ú©Ø§Ø± (Ø­Ø¯Ø§Ú©Ø«Ø± 120 Ú©Ø§Ø±Ø§Ú©ØªØ±)</label>
                        <textarea name="partner_brand" id="id_partner_brand" class="form-control" 
                                  placeholder="Ø§Ø³Ø§Ù…ÛŒ Ø¨Ø±Ù†Ø¯Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¨Ø§ Ø¢Ù†â€ŒÙ‡Ø§ Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø´Ø¯Ù‡"
                                  rows="2" maxlength="120">{{ form.partner_brand.value|default:'' }}</textarea>
                        <div class="char-counter" id="partner-counter">0/120</div>
                    </div>
                    <div>
                        <label for="id_bank_account">Ø´Ù…Ø§Ø±Ù‡ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù†Ú©ÛŒ</label>
                        <input type="text" name="bank_account" id="id_bank_account" 
                               placeholder="ÛŒÚ© Ø´Ù…Ø§Ø±Ù‡ Ø´Ø¨Ø§ Ù…Ø¹ØªØ¨Ø± Û²Û´ Ø±Ù‚Ù…ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"
                               class="form-control" value="{{ form.bank_account.value|default:'' }}" 
                               maxlength="25">
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label for="id_file">ÙØ§ÛŒÙ„ Ø±Ø²ÙˆÙ…Ù‡ (PDF ÛŒØ§ ZIP - Ø­Ø¯Ø§Ú©Ø«Ø± 10MB)</label>
                    
                    <!-- Ø¬Ø¯Ø§ Ú©Ø±Ø¯Ù† Ù„ÛŒÙ†Ú© Ø¯Ø§Ù†Ù„ÙˆØ¯ -->
                    <div style="margin-bottom: 10px; padding: 8px; background-color: #f0f8ff; border-radius: 5px; border: 1px solid #cce7ff;">
                        <a href="{% static 'advplatform/assets/files/sample_cv.pdf' %}" 
                           download="Ù†Ù…ÙˆÙ†Ù‡_Ø±Ø²ÙˆÙ…Ù‡.pdf" 
                           target="_blank"
                           onclick="event.stopPropagation();"
                           style="color: #007bff; text-decoration: none; font-size: 14px; font-weight: bold; cursor: pointer;">
                            ğŸ“„ Ø¯Ø±ÛŒØ§ÙØª Ù†Ù…ÙˆÙ†Ù‡ PDF
                        </a>
                        <small style="color: #666; margin-right: 10px;">
                            (Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙØ±Ù…Øª Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø±Ø²ÙˆÙ…Ù‡)
                        </small>
                    </div>
                    
                    <div class="custom-file-upload">
                        <input type="file" name="file" id="id_file" class="form-control" 
                               accept=".pdf,.zip" style="display: none;">
                        <div class="file-upload-btn" id="file-upload-button">
                            <div class="file-name-display" id="file-name-display">ÙØ§ÛŒÙ„ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù…Ø§ÛŒÛŒØ¯</div>
                            <div class="file-select-btn">Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„</div>
                        </div>
                    </div>
                    {% if resume and resume.file %}
                        <p style="margin-top: 5px; font-size: 12px;">ÙØ§ÛŒÙ„ ÙØ¹Ù„ÛŒ: <a href="{{ resume.file.url }}" target="_blank">Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙØ§ÛŒÙ„</a></p>
                    {% endif %}
                </div>

                <div style="margin-top: 30px;">
                    {% if is_edit_mode %}
                        <button type="submit">ÙˆÛŒØ±Ø§ÛŒØ´ Ø±Ø²ÙˆÙ…Ù‡</button>
                    {% else %}
                        <button type="submit">Ø§Ø±Ø³Ø§Ù„ Ø±Ø²ÙˆÙ…Ù‡</button>
                    {% endif %}
                    <a href="{% url 'account:home' %}" class="btn btn-secondary">Ø¨Ø§Ø²Ú¯Ø´Øª</a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Ù…Ø¯Ø§Ù„ Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø³ØªØ§Ù† Ùˆ Ø´Ù‡Ø± -->
<div class="modal" id="cityModal" tabindex="-1" style="display:none; position:fixed; z-index:9999; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3);">
    <div style="background:#fff; max-width:500px; margin:40px auto; border-radius:10px; padding:20px; position:relative;">
        <h4 style="margin-bottom:10px;">Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù‡Ø±</h4>
        <input type="text" id="city-search" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø´Ù‡Ø±Ù‡Ø§..." class="form-control" style="margin-bottom:10px;">
        <div id="province-list" style="max-height:350px; overflow-y:auto;">
            <!-- Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§ Ùˆ Ø´Ù‡Ø±Ù‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø§ Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
        </div>
        <div style="margin-top:20px; text-align:left;">
            <button type="button" class="btn btn-success" id="city-modal-confirm">ØªØ§ÛŒÛŒØ¯</button>
            <button type="button" class="btn btn-secondary" id="city-modal-cancel">Ø§Ù†ØµØ±Ø§Ù</button>
        </div>
    </div>
</div>

<!-- Ù…Ø¯Ø§Ù„ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù…ÙˆÙ†Ù‡ Ú©Ø§Ø± -->
<div class="modal" id="portfolioModal" tabindex="-1" style="display:none; position:fixed; z-index:9999; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3);">
    <div style="background:#fff; max-width:600px; margin:40px auto; border-radius:10px; padding:20px; position:relative;">
        <h4 style="margin-bottom:10px;">Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù…ÙˆÙ†Ù‡ Ú©Ø§Ø±</h4>
        <div id="portfolio-list" style="max-height:350px; overflow-y:auto;">
            <!-- Ù†Ù…ÙˆÙ†Ù‡ Ú©Ø§Ø±Ù‡Ø§ Ø¨Ø§ Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
        </div>
        <hr>
        <h5>Ø§ÙØ²ÙˆØ¯Ù† Ù†Ù…ÙˆÙ†Ù‡ Ú©Ø§Ø± Ø¬Ø¯ÛŒØ¯</h5>
        <form id="portfolio-add-form">
            {% csrf_token %}
            <input type="text" name="subject" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù†Ù…ÙˆÙ†Ù‡ Ú©Ø§Ø±" class="form-control" style="margin-bottom:5px;" required>
            <textarea name="description" placeholder="Ø´Ø±Ø­ Ù†Ù…ÙˆÙ†Ù‡ Ú©Ø§Ø±" class="form-control" style="margin-bottom:5px;"></textarea>
            <input type="file" name="image" class="form-control" style="margin-bottom:5px;">
            <input type="date" name="done_time" class="form-control" style="margin-bottom:5px;" required>
            <button type="submit" class="btn btn-success" style="margin-bottom:5px;">Ø§ÙØ²ÙˆØ¯Ù†</button>
        </form>
        <div style="margin-top:20px; text-align:left;">
            <button type="button" class="btn btn-success" id="portfolio-modal-confirm">ØªØ§ÛŒÛŒØ¯</button>
            <button type="button" class="btn btn-secondary" id="portfolio-modal-cancel">Ø§Ù†ØµØ±Ø§Ù</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Ø³Ø±ÙˆØ± (Ù‡Ù…Ø§Ù† Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ)
    const provinces = {{ provinces|safe }};
    const selectedCityIds = {{ selected_cities|safe }};
    let userPortfolios = {{ user_portfolios|safe }};
    const selectedPortfolioIds = {{ selected_portfolios|safe }};

    // Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ù†ÙˆØ¹ Ù…Ø¬Ø±ÛŒ ØªØ¨Ù„ÛŒØºØ§Øª
    const dealerTypeCards = document.querySelectorAll(".dealer-type-card");
    const hiddenDealerInput = document.getElementById("selected-dealer-type-id");
    const specialtyCategoriesContainer = document.getElementById('specialty-categories-container');

    function resetDealerCardStyles() {
        dealerTypeCards.forEach(card => {
            card.classList.remove("selected");
            card.style.borderColor = "#ddd";
            card.style.backgroundColor = "#fff";
        });
    }

    function loadSpecialtyCategories(dealerTypeId) {
        if (!dealerTypeId) {
            specialtyCategoriesContainer.innerHTML = '<div class="empty-message">Ø§Ø¨ØªØ¯Ø§ Ù†ÙˆØ¹ Ù…Ø¬Ø±ÛŒ ØªØ¨Ù„ÛŒØºØ§Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</div>';
            return;
        }
        specialtyCategoriesContainer.innerHTML = '<div class="empty-message">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>';
        
        fetch(`/account/get-specialty-categories/?dealer_type_id=${dealerTypeId}`)
            .then(response => response.json())
            .then(data => {
                specialtyCategoriesContainer.innerHTML = '';
                if (data.categories && data.categories.length > 0) {
                    data.categories.forEach(category => {
                        const div = document.createElement('div');
                        div.style.marginLeft = "15px";
                        div.innerHTML = `
                            <label>
                                <input type="radio" name="specialty_categories" value="${category.id}">
                                ${category.name}
                            </label>
                        `;
                        specialtyCategoriesContainer.appendChild(div);
                    });
                    
                    const selectedCategory = {{ selected_specialty_categories|safe }};
                    if (selectedCategory.length > 0) {
                        const radio = specialtyCategoriesContainer.querySelector(`input[value="${selectedCategory[0]}"]`);
                        if (radio) radio.checked = true;
                    }
                } else {
                    specialtyCategoriesContainer.innerHTML = '<div class="empty-message">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ ØªØ®ØµØµÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù†ÙˆØ¹ Ù…Ø¬Ø±ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</div>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                specialtyCategoriesContainer.innerHTML = '<div class="empty-message">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</div>';
            });
    }

    dealerTypeCards.forEach(card => {
        card.addEventListener("click", () => {
            resetDealerCardStyles();
            card.classList.add("selected");
            const color = card.dataset.color || "#028c32";
            card.style.borderColor = color;
            hiddenDealerInput.value = card.dataset.id;
            
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ ØªØ®ØµØµÛŒ
            loadSpecialtyCategories(card.dataset.id);
        });

        // Ø§Ú¯Ø± Ú©Ø§Ø±Øª Ø§Ø² Ù‚Ø¨Ù„ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
        if (card.classList.contains("selected")) {
            const color = card.dataset.color || "#028c32";
            card.style.borderColor = color;
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ ØªØ®ØµØµÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø§ÙˆÙ„ÛŒÙ‡
            loadSpecialtyCategories(card.dataset.id);
        }
    });

    // Ø§Ú¯Ø± Ù…Ù‚Ø¯Ø§Ø± Ø§Ø² Ù‚Ø¨Ù„ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ (Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª ÙˆÛŒØ±Ø§ÛŒØ´)
    if (hiddenDealerInput.value) {
        loadSpecialtyCategories(hiddenDealerInput.value);
    }

    // Ø¨Ø§Ù‚ÛŒ Ú©Ø¯Ù‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ (Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ú©Ø§Ø±Ø§Ú©ØªØ±ØŒ Ù…Ø¯Ø§Ù„â€ŒÙ‡Ø§ Ùˆ...)
    
    // ØªØ§Ø¨Ø¹ Ø´Ù…Ø§Ø±Ø´ Ú©Ø§Ø±Ø§Ú©ØªØ±
    function setupCharacterCounter(fieldId, counterId, maxLength) {
        const field = document.getElementById(fieldId);
        const counter = document.getElementById(counterId);
        
        function updateCounter() {
            const currentLength = field.value.length;
            counter.textContent = `${currentLength}/${maxLength}`;
            
            if (currentLength > maxLength) {
                counter.classList.add('over-limit');
            } else {
                counter.classList.remove('over-limit');
            }
        }
        
        field.addEventListener('input', updateCounter);
        updateCounter();
    }
    
    // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø§Ú©ØªØ±
    setupCharacterCounter('id_describe', 'describe-counter', 250);
    setupCharacterCounter('id_services', 'services-counter', 120);
    setupCharacterCounter('id_socialmedia_and_sites', 'socialmedia-counter', 120);
    setupCharacterCounter('id_tools_and_platforms', 'tools-counter', 120);
    setupCharacterCounter('id_partner_brand', 'partner-counter', 120);

    // Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø¯Ø§Ù„ Ø´Ù‡Ø±Ù‡Ø§
    function renderProvinceList(filter="") {
        const container = document.getElementById('province-list');
        container.innerHTML = "";
        
        provinces.forEach(province => {
            const filteredCities = province.cities.filter(city => city.name.includes(filter));
            if (filter && filteredCities.length === 0 && !province.name.includes(filter)) return;

            const provinceDiv = document.createElement('div');
            provinceDiv.style.marginBottom = "10px";
            provinceDiv.innerHTML = `
                <div style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;">
                    <div>
                        <input type="checkbox" class="province-all" data-province="${province.id}">
                        <span style="font-weight:bold;">${province.name}</span>
                    </div>
                    <span class="toggle-cities" data-province="${province.id}" style="font-size:18px;cursor:pointer;">&#x25BC;</span>
                </div>
                <div class="cities-list" id="cities-list-${province.id}" style="display:none; margin-right:20px; margin-top:5px;"></div>
            `;
            container.appendChild(provinceDiv);

            const citiesList = provinceDiv.querySelector(`#cities-list-${province.id}`);
            province.cities.forEach(city => {
                const checked = selectedCityIds.includes(city.id) ? "checked" : "";
                const cityDiv = document.createElement('div');
                cityDiv.innerHTML = `
                    <label style="display:flex;align-items:center;">
                        <input type="checkbox" class="city-checkbox" data-city="${city.id}" data-province="${province.id}" ${checked}>
                        <span>${city.name}</span>
                    </label>
                `;
                citiesList.appendChild(cityDiv);
            });

            provinceDiv.querySelector('.toggle-cities').onclick = function() {
                const list = provinceDiv.querySelector('.cities-list');
                list.style.display = list.style.display === "none" ? "block" : "none";
                this.innerHTML = list.style.display === "none" ? "&#x25BC;" : "&#x25B2;";
            };

            provinceDiv.querySelector('.province-all').onclick = function() {
                const checked = this.checked;
                citiesList.querySelectorAll('.city-checkbox').forEach(cb => cb.checked = checked);
            };
        });
    }

    document.getElementById('open-city-modal').onclick = function() {
        document.getElementById('cityModal').style.display = "block";
        renderProvinceList();
    };

    document.getElementById('city-modal-cancel').onclick = function() {
        document.getElementById('cityModal').style.display = "none";
    };

    document.getElementById('city-search').oninput = function() {
        renderProvinceList(this.value.trim());
    };

    document.getElementById('city-modal-confirm').onclick = function() {
        const checkedCities = [];
        document.querySelectorAll('.city-checkbox:checked').forEach(cb => {
            checkedCities.push(parseInt(cb.getAttribute('data-city')));
        });
        
        document.getElementById('service_area_input').value = checkedCities.join(',');
        
        const selectedNames = [];
        provinces.forEach(province => {
            province.cities.forEach(city => {
                if (checkedCities.includes(city.id)) selectedNames.push(city.name);
            });
        });
        
        document.getElementById('selected-cities-summary').innerText = selectedNames.length ? selectedNames.join('ØŒ ') : 'Ù‡ÛŒÚ† Ø´Ù‡Ø±ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª';
        document.getElementById('cityModal').style.display = "none";
    };

    // Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø¯Ø§Ù„ Ù†Ù…ÙˆÙ†Ù‡ Ú©Ø§Ø±Ù‡Ø§
    function renderPortfolioList() {
        const container = document.getElementById('portfolio-list');
        container.innerHTML = "";
        
        if (userPortfolios.length === 0) {
            container.innerHTML = '<div class="empty-message">Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² Ù†Ù…ÙˆÙ†Ù‡ Ú©Ø§Ø±ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.</div>';
            return;
        }
        
        userPortfolios.forEach(portfolio => {
            const checked = selectedPortfolioIds.includes(portfolio.id) ? "checked" : "";
            const div = document.createElement('div');
            div.className = "portfolio-item";
            div.innerHTML = `
                <label>
                    <input type="checkbox" class="portfolio-checkbox-input" data-portfolio="${portfolio.id}" ${checked}>
                    <div>
                        <strong>${portfolio.subject || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}</strong><br>
                        <small>${portfolio.description || ''}</small>
                    </div>
                </label>
            `;
            container.appendChild(div);
        });
    }

    document.getElementById('open-portfolio-modal').onclick = function() {
        document.getElementById('portfolioModal').style.display = "block";
        renderPortfolioList();
    };

    document.getElementById('portfolio-modal-cancel').onclick = function() {
        document.getElementById('portfolioModal').style.display = "none";
    };

    document.getElementById('portfolio-modal-confirm').onclick = function() {
        const checkedPortfolios = [];
        document.querySelectorAll('.portfolio-checkbox-input:checked').forEach(cb => {
            checkedPortfolios.push(parseInt(cb.getAttribute('data-portfolio')));
        });
        
        document.getElementById('portfolios_input').value = checkedPortfolios.join(',');
        
        const selectedNames = [];
        userPortfolios.forEach(portfolio => {
            if (checkedPortfolios.includes(portfolio.id)) selectedNames.push(portfolio.subject || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†');
        });
        
        document.getElementById('selected-portfolios-summary').innerText = selectedNames.length ? selectedNames.join('ØŒ ') : 'Ù‡ÛŒÚ† Ù†Ù…ÙˆÙ†Ù‡ Ú©Ø§Ø±ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª';
        document.getElementById('portfolioModal').style.display = "none";
    };

    // Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„
    const fileInput = document.getElementById('id_file');
    const fileUploadButton = document.getElementById('file-upload-button');
    const fileNameDisplay = document.getElementById('file-name-display');

    if (fileUploadButton) {
        fileUploadButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            fileInput.click();
        });
    }

    if (fileInput) {
        fileInput.addEventListener('change', function() {
            if (this.files && this.files.length > 0) {
                fileNameDisplay.textContent = this.files[0].name;
            } else {
                fileNameDisplay.textContent = 'ÙØ§ÛŒÙ„ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù…Ø§ÛŒÛŒØ¯';
            }
        });
    }

    // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² click event Ø¯Ø± Ù„ÛŒÙ†Ú© Ø¯Ø§Ù†Ù„ÙˆØ¯
    document.addEventListener('click', function(e) {
        if (e.target.matches('a[download]')) {
            e.stopPropagation();
        }
    });

    // Ø§ÙØ²ÙˆØ¯Ù† Ù†Ù…ÙˆÙ†Ù‡ Ú©Ø§Ø± Ø¬Ø¯ÛŒØ¯
    document.getElementById('portfolio-add-form').onsubmit = function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        fetch('/account/portfolio/ajax-add/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                userPortfolios.push(data.portfolio);
                renderPortfolioList();
                this.reset();
                alert('Ù†Ù…ÙˆÙ†Ù‡ Ú©Ø§Ø± Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
            } else {
                alert(data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ù†Ù…ÙˆÙ†Ù‡ Ú©Ø§Ø±');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ù†Ù…ÙˆÙ†Ù‡ Ú©Ø§Ø±');
        });
    };
});
</script>

{% endblock %}