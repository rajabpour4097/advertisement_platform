{% extends "account/account_base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% load account_tags %}

{% block title %}بررسی رزومه - {{ resume.user.get_full_name }}{% endblock %}

{% block content %}
<style>

     /* placeholders pattern for locked items */
  .locked-thumb{width:110px;height:90px;position:relative;border:1px solid #e5e7eb;border-radius:6px;overflow:hidden;background:repeating-linear-gradient(45deg,#d1d5db,#d1d5db 10px,#e5e7eb 10px,#e5e7eb 20px);} 
  .locked-thumb:before{content:"";position:absolute;inset:0;backdrop-filter:blur(6px);background:rgba(255,255,255,.35);} 
  .locked-thumb .lock-overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:24px;color:#374151;z-index:2;text-shadow:0 0 6px #fff;} 
  .locked-thumb .lock-overlay span{font-size:10px;margin-top:4px;direction:rtl;text-align:center;line-height:1.3;color:#1f2937;padding:0 4px;} 
  .locked-map{height:320px;width:100%;border:1px solid #ddd;border-radius:6px;margin-top:10px;position:relative;overflow:hidden;background:repeating-linear-gradient(135deg,#cfd8e3,#cfd8e3 14px,#e2e8f0 14px,#e2e8f0 28px);} 
  .locked-map:before{content:"";position:absolute;inset:0;backdrop-filter:blur(8px);background:linear-gradient(135deg,rgba(255,255,255,.5),rgba(255,255,255,.3));} 
  .locked-map .lock-icon{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#1f2937;font-size:46px;z-index:2;text-shadow:0 0 10px #fff;} 
  .locked-map .lock-icon div{font-size:13px;margin-top:8px;direction:rtl;text-align:center;padding:0 8px;}  

    .resume-detail {
        max-width: 1100px;
        margin: 0 auto;
    }
    /* اضافه شده: قاب اسکرول برای محتوای طولانی */
    .resume-scroll-wrapper {
        max-height: calc(100vh - 220px); /* بر اساس ارتفاع هدر/فوتر قالب قابل تنظیم است */
        overflow-y: auto;
        padding-inline-end: 8px; /* جا برای اسکرول */
    }
    /* زیباسازی اسکرول (اختیاری) */
    .resume-scroll-wrapper::-webkit-scrollbar {
        width: 8px;
    }
    .resume-scroll-wrapper::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    .resume-scroll-wrapper::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }
    .resume-scroll-wrapper::-webkit-scrollbar-thumb:hover {
        background: #a0a0a0;
    }

    .status-badge {
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 14px;
        display: inline-block;
        margin-bottom: 20px;
    }

    .status-pending { background-color: #fff3cd; color: #856404; }
    .status-under_review { background-color: #cce5ff; color: #004085; }
    .status-needs_editing { background-color: #ffe4b3; color: #856404; }
    .status-approved { background-color: #d4edda; color: #155724; }
    .status-rejected { background-color: #f8d7da; color: #721c24; }

    .info-section {
        background: #f8f9fa;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }

    .info-section h4 {
        color: #495057;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }

    .review-form {
        background: #ffffff;
        padding: 25px;
        border-radius: 8px;
        border: 2px solid #007bff;
        margin-top: 30px;
    }

    .review-form h3 {
        color: #007bff;
        margin-bottom: 20px;
    }

    .field-row {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
    }

    .field-row > div {
        flex: 1;
    }

    .btn-group {
        text-align: center;
        margin-top: 20px;
    }

    .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
        padding: 10px 30px;
    }

    .permissions-list, .worklinks-list, .portfolio-list {
        list-style: none;
        padding: 0;
    }

    .permissions-list li, .worklinks-list li, .portfolio-list li {
        background: #f1f3f4;
        margin: 10px 0;
        padding: 15px;
        border-radius: 5px;
        border-left: 4px solid #007bff;
    }

    .file-link {
        color: #007bff;
        text-decoration: none;
        font-weight: bold;
    }

    .file-link:hover {
        text-decoration: underline;
    }

    .comment-display {
        background: #fff3cd;
        padding: 15px;
        border-radius: 5px;
        border-left: 4px solid #ffc107;
        margin: 15px 0;
    }
    .image-logo {
        max-width: 60px;
        border-radius: 5px;
    }
    .portfolio-image{
        width: 100px;
        border-radius: 5px;
    }

    /* Service area (cities) styling */
    .province-city-wrapper {margin-top:10px;}
    .province-city-list {list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:18px;}
    .province-block {background:#ffffff;border:1px solid #e3e8ef;border-radius:10px;padding:14px 16px;box-shadow:0 2px 4px rgba(0,0,0,.04);}    
    .province-name {font-weight:600;font-size:14px;display:inline-flex;align-items:center;gap:6px;color:#0d6efd;margin-bottom:10px;}
    .province-name:before {content:"";width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,#5aa2ff,#1d72e8);display:inline-block;box-shadow:0 0 0 3px rgba(13,110,253,.15);} 
    .city-badges {list-style:none;padding:0;margin:0;display:flex;flex-wrap:wrap;gap:8px;}
    .city-badge {background:linear-gradient(145deg,#f0f6ff,#e3efff);border:1px solid #c6ddfa;padding:6px 14px;font-size:12.5px;border-radius:22px;position:relative;color:#0f406e;font-weight:500;letter-spacing:.2px;display:inline-flex;align-items:center;gap:4px;}
    .city-badge:before {content:"\f279"; /* fa-map-marker-alt */ font-family:"Font Awesome 5 Free";font-weight:900;font-size:11px;color:#1d72e8;}
    .city-badge:hover {background:#e6f1ff;border-color:#b0d1f6;}
    .province-block.empty {opacity:.6;}
    .no-cities-note {font-size:13px;color:#6b7280;margin-top:6px;}
    @media (max-width:600px){
        .city-badge {font-size:11.5px;padding:5px 11px;}
        .province-block {padding:12px 13px;}
    }

</style>

<div class="container-fluid resume-detail">
    <div class="x_panel">
        <div class="x_title">
            <h2>رزومه <h2 style="font-size:14px">آقا/خانم/شرکت</h2></h2>
            <h2 style="color:#007bff; margin-right: 10px;">{{ resume.user.get_full_name }}</h2>  
            <button type="button" onclick="window.history.back();" style="margin-right:50px;">
                بازگشت
            </button>
            <div class="clearfix"></div>
        </div>

        <div class="x_content">
           <div class="resume-scroll-wrapper">
            <!-- اطلاعات اصلی رزومه -->
            <div class="info-section">
                <h4>اطلاعات اصلی</h4>
                <div class="field-row">
                    <div><strong>نام مجری:</strong> 
                        {% if resume.user.get_full_name %}
                            {{ resume.user.get_full_name }}
                        {% else%} 
                            {{ resume.user.email }}
                        {% endif %}
                    </div>
                    <div><strong>نوع مجری:</strong> {{ resume.dealer_type|default:"تعریف نشده" }}</div>
                </div>
                <div class="field-row">
                    <div><strong>دسته تخصصی:</strong> {{ resume.specialty_categories|default:"تعریف نشده" }}</div>
                    <div><strong>{% if resume.user.customer_type == 'juridical' %}لوگوی شرکتی:{% else %}تصویر کاربر:{% endif %}</strong> 
                     
                      {% if resume.user.customuserimages.first.image.url %}
                        <div class="d-flex flex-wrap gap-2 mt-2">
                            <div class="locked-thumb" title="تصویر این کاربر در حال حاضر قفل هستند و بعد از انتخاب طرح به عنوان برنده نمایش داده می‌شود">
                              <div class="lock-overlay"><i class="fa fa-lock"></i><span>قفل شده</span></div>
                            </div>
                        </div>
                      {% else %}
                         <img class="image-logo" src="{% static 'account/build/images/user.png' %}" alt="">
                      {% endif %}
                    </div>
                </div>
                    <div>
                        <strong>معرفی مختصر از خود:</strong>
                        {% if resume.describe %}
                            {{ resume.describe|linebreaksbr }}
                        {% else %}
                            چیزی ثبت نشده
                        {% endif %}
                    </div>
            </div>

            <!-- خدمات و تخصص -->
            <div class="info-section">
                <h4>خدمات و تخصص</h4>
                {% if resume.services %}
                    <div><strong>خدمات قابل ارائه: </strong>{{ resume.services|linebreaksbr }}</div>
                    
                {% endif %}
                
                {% if resume.specialty_categories.exists %}
                    <div><strong>دسته‌های تخصصی: </strong>{{ resume.specialty_categories }}</div>
                {% endif %}
            </div>

            <!-- خدمات و تخصص -->
            <div class="info-section">
                <h4>حوزه خدمات</h4>
                {% if resume.service_area.exists %}
                    {% regroup resume.service_area.all by province as province_list %}
                    <div class="province-city-wrapper">
                        <div style="font-weight:600;font-size:13px;color:#374151;display:flex;align-items:center;gap:6px;">
                            <span style="width:8px;height:8px;border-radius:50%;background:#0d6efd;box-shadow:0 0 0 3px rgba(13,110,253,.15);"></span>
                            لیست شهرهای تحت پوشش ({{ resume.service_area.count }})
                        </div>
                        <ul class="province-city-list">
                            {% for province in province_list %}
                                <li class="province-block {% if not province.list %}empty{% endif %}">
                                    <div class="province-name">{{ province.grouper.name }}</div>
                                    {% if province.list %}
                                        <ul class="city-badges">
                                            {% for city in province.list %}
                                                <li class="city-badge" title="{{ city.name }} / {{ province.grouper.name }}">{{ city.name }}</li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <div class="no-cities-note">شهری ثبت نشده</div>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% else %}
                    <p class="no-cities-note">هیچ شهری ثبت نشده است.</p>
                {% endif %}
            </div>

            <!-- اطلاعات تکمیلی -->
            <div class="info-section">
                <h4>اطلاعات تکمیلی</h4>
                
                    <div><strong>شبکه‌های اجتماعی و وب‌سایت‌ها: </strong>
                        {% if resume.socialmedia_and_sites %}
                        {{ resume.socialmedia_and_sites|linebreaksbr }}
                        {% else %}
                            چیزی ثبت نشده
                        {% endif %}
                    </div>
                    <br>
                    <div><strong>ابزارها و پلتفرم‌های مورد استفاده:</strong>
                        {% if resume.tools_and_platforms %}
                            {{ resume.tools_and_platforms|linebreaksbr }}
                        {% else %}
                            چیزی ثبت نشده
                        {% endif %}
                    </div>
                    <br>
                    <div><strong>برندهای همکار:</strong>
                        {% if resume.partner_brand %}
                            {{ resume.partner_brand|linebreaksbr }}
                        {% else %}
                            چیزی ثبت نشده
                        {% endif %}
                    </div>
                    <br>
                
                    <div><strong>شماره حساب بانکی: IR </strong> 
                        {% if resume.bank_account %}
                            {{ resume.bank_account }}
                        {% else %}
                            تعریف نشده
                        {% endif %}
                    </div>
                    <br>
                    <div><strong>فایل رزومه:</strong> 
                        {% if resume.file %}
                            <a href="{{ resume.file.url }}" target="_blank" class="file-link">مشاهده فایل</a>
                        {% else %}
                            فایلی آپلود نشده
                        {% endif %}
                    </div>
            </div>

            <!-- مجوزها -->
            
            <div class="info-section">
                {% if permissions %}
                    <h4>مجوزها و گواهی‌نامه‌ها ({{ permissions.count }})</h4>
                    <ul class="permissions-list">
                        {% for permission in permissions %}
                            <li>
                                <strong>{{ permission.title }}</strong>
                                {% if permission.description %}
                                    <p>{{ permission.description }}</p>
                                {% endif %}
                                {% if permission.issue_date %}
                                    <small>تاریخ صدور: {{ permission.issue_date }}</small>
                                {% endif %}
                                {% if permission.expiry_date %}
                                    <small> | تاریخ انقضا: {{ permission.expiry_date }}</small>
                                    {% if permission.is_expired %}
                                        <span style="color: red; font-weight: bold;"> (منقضی شده)</span>
                                    {% endif %}
                                {% endif %}
                                <br>
                                <a href="{{ permission.file.url }}" target="_blank" class="file-link">مشاهده فایل</a>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>هیچ مجوز یا گواهی‌نامه‌ای ثبت نشده.</p>
                {% endif %}
            </div>

            <!-- لینک‌های نمونه کار -->
            <div class="info-section">
                <h4>لینک‌های نمونه کارها ({{ work_links.count }})</h4>
                {% if work_links %}
                    <ul class="worklinks-list">
                        {% for link in work_links %}
                            <li>
                                <strong>{{ link.title }}</strong>
                                {% if link.is_featured %}
                                    <span style="color: gold;">⭐ برجسته</span>
                                {% endif %}
                                {% if link.description %}
                                    <p>{{ link.description }}</p>
                                {% endif %}
                                {% if link.category %}
                                    <small>دسته‌بندی: {{ link.category }}</small>
                                {% endif %}
                                {% if link.completion_date %}
                                    <small> | تاریخ تکمیل: {{ link.completion_date }}</small>
                                {% endif %}
                                <br>
                                <a href="{{ link.url }}" target="_blank" class="file-link">{{ link.url }}</a>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>هیچ لینک نمونه کاری ثبت نشد.</p>
                {% endif %}
            </div>

            <!-- نمونه کارها -->
            <div class="info-section">
                {% if resume.portfolios.all %}
                    <h4>نمونه کارها ({{ resume.portfolios.count }})</h4>    
                    <ul class="portfolio-list">
                        {% for portfolio in resume.portfolios.all %}
                            <li>
                                <strongx>{{ portfolio.title }}</strongx>
                                <p>{{ portfolio.description }}</p>
                                <p>دسته‌بندی: {{ portfolio.topic.name }}</p>
                                <p>تاریخ تکمیل: {{ portfolio.done_time | jalali_timedate }}</p>
                                <br>
                                {% for image in portfolio.portfolioimages.all %}
                                    <a href="{{ image.image.url }}" target="_blank">
                                        <img src="{{ image.image.url }}" class="portfolio-image">
                                    </a>
                                {% endfor %}
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>هیچ نمونه کاری ثبت نشد.</p>
                {% endif %}
            </div>

            </div>  {# پایان resume-scroll-wrapper #}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusSelect = document.getElementById('id_status');
    const commentField = document.getElementById('id_manager_comment');
    
    
    // تریگر کردن event برای مقدار اولیه
    statusSelect.dispatchEvent(new Event('change'));
});
</script>

{% endblock %}

