{% extends "account/account_base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% load account_tags %}

{% block title %}بررسی رزومه - {{ resume.user.get_full_name }}{% endblock %}

{% block content %}
<style>
    .resume-detail {
        max-width: 1100px;
        margin: 0 auto;
    }
    /* اضافه شده: قاب اسکرول برای محتوای طولانی */
    .resume-scroll-wrapper {
        max-height: calc(100vh - 220px); /* بر اساس ارتفاع هدر/فوتر قالب قابل تنظیم است */
        overflow-y: auto;
        padding-inline-end: 8px; /* جا برای اسکرول */
    }
    /* زیباسازی اسکرول (اختیاری) */
    .resume-scroll-wrapper::-webkit-scrollbar {
        width: 8px;
    }
    .resume-scroll-wrapper::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    .resume-scroll-wrapper::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }
    .resume-scroll-wrapper::-webkit-scrollbar-thumb:hover {
        background: #a0a0a0;
    }

    .status-badge {
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 14px;
        display: inline-block;
        margin-bottom: 20px;
    }

    .status-pending { background-color: #fff3cd; color: #856404; }
    .status-under_review { background-color: #cce5ff; color: #004085; }
    .status-needs_editing { background-color: #ffe4b3; color: #856404; }
    .status-approved { background-color: #d4edda; color: #155724; }
    .status-rejected { background-color: #f8d7da; color: #721c24; }

    .info-section {
        background: #f8f9fa;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }

    .info-section h4 {
        color: #495057;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }

    .review-form {
        background: #ffffff;
        padding: 25px;
        border-radius: 8px;
        border: 2px solid #007bff;
        margin-top: 30px;
    }

    .review-form h3 {
        color: #007bff;
        margin-bottom: 20px;
    }

    .field-row {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
    }

    .field-row > div {
        flex: 1;
    }

    .btn-group {
        text-align: center;
        margin-top: 20px;
    }

    .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
        padding: 10px 30px;
    }

    .permissions-list, .worklinks-list {
        list-style: none;
        padding: 0;
    }

    .permissions-list li, .worklinks-list li {
        background: #f1f3f4;
        margin: 10px 0;
        padding: 15px;
        border-radius: 5px;
        border-left: 4px solid #007bff;
    }

    .file-link {
        color: #007bff;
        text-decoration: none;
        font-weight: bold;
    }

    .file-link:hover {
        text-decoration: underline;
    }

    .comment-display {
        background: #fff3cd;
        padding: 15px;
        border-radius: 5px;
        border-left: 4px solid #ffc107;
        margin: 15px 0;
    }
    .image-logo {
        max-width: 60px;
        border-radius: 5px;
    }
</style>

<div class="container-fluid resume-detail">
    <div class="x_panel">
        <div class="x_title">
            <h2>بررسی رزومه - {{ resume.user.get_full_name }}</h2>
            <div class="clearfix"></div>
        </div>

        <div class="x_content">
           <div class="resume-scroll-wrapper">
            <!-- نمایش وضعیت فعلی -->
            <div class="status-badge status-{{ resume.status }}">
                وضعیت: {{ resume.get_status_display }}
            </div>

            <!-- نمایش کامنت قبلی مدیر -->
            {% if resume.manager_comment %}
                <div class="comment-display">
                    <strong>نظر قبلی مدیر:</strong>
                    <p>{{ resume.manager_comment|linebreaksbr }}</p>
                </div>
            {% endif %}

            <!-- اطلاعات اصلی رزومه -->
            <div class="info-section">
                <h4>اطلاعات اصلی</h4>
                <div class="field-row">
                    <div><strong>نام مجری:</strong> {% if resume.user.get_full_name %}{{ resume.user.get_full_name }}{% else%} {{ resume.user.email }}{% endif %}</div>
                    <div><strong>نوع مجری:</strong> {{ resume.dealer_type|default:"تعریف نشده" }}</div>
                </div>
                <div class="field-row">
                    <div><strong>دسته تخصصی:</strong> {{ resume.specialty_categories|default:"تعریف نشده" }}</div>
                    <div><strong>{% if resume.user.customer_type == 'juridical' %}لوگوی شرکتی:{% else %}تصویر کاربر:{% endif %}</strong> 
                        {% if resume.user.customuserimages.first.image.url %}
                            <img class="image-logo" src="{{ resume.user.customuserimages.first.image.url }}" alt="">
                        {% else %}
                            <img class="image-logo" src="{% static 'account/build/images/user.png' %}" alt="">
                        {% endif %}</div>
                </div>
                <div class="field-row">
                    <div><strong>تاریخ ایجاد:</strong> {{ resume.created_at|jalali_timedate }}</div>
                    <div><strong>تاریخ آخرین ویرایش:</strong> {{ resume.updated_at|jalali_timedate }}</div>
                </div>
                {% if resume.describe %}
                    <div><strong>توضیحات:</strong></div>
                    <p>{{ resume.describe|linebreaksbr }}</p>
                {% endif %}
            </div>

            <!-- خدمات و تخصص -->
            <div class="info-section">
                <h4>خدمات و تخصص</h4>
                {% if resume.services %}
                    <div><strong>خدمات قابل ارائه:</strong></div>
                    <p>{{ resume.services|linebreaksbr }}</p>
                {% endif %}
                
                {% if resume.specialty_categories.exists %}
                    <div><strong>دسته‌های تخصصی:</strong></div>
                    <ul>
                        {% for category in resume.specialty_categories.all %}
                            <li>{{ category.name }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>

            <!-- خدمات و تخصص -->
            <div class="info-section">
                <h4>حوزه خدمات</h4>
                {% if resume.service_area.exists %}
                    <div><strong>لیست شهرها:</strong></div>
                    <ul>
                        {% for city in resume.service_area.all %}
                            <li>{{ city.name }} - {{ city.province.name }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>

            <!-- اطلاعات تکمیلی -->
            <div class="info-section">
                <h4>اطلاعات تکمیلی</h4>
                
                    <div><strong>شبکه‌های اجتماعی و وب‌سایت‌ها:</strong></div>
                    {% if resume.socialmedia_and_sites %}
                        <p>{{ resume.socialmedia_and_sites|linebreaksbr }}</p>
                    {% else %}
                        <p>تعریف نشده</p>
                    {% endif %}
                    <div><strong>ابزارها و پلتفرم‌ها:</strong></div>
                    {% if resume.tools_and_platforms %}
                        <p>{{ resume.tools_and_platforms|linebreaksbr }}</p>
                    {% else %}
                        <p>تعریف نشده</p>
                    {% endif %}
                
                {% if resume.partner_brand %}
                    <div><strong>برندهای همکار:</strong></div>
                    <p>{{ resume.partner_brand|linebreaksbr }}</p>
                {% endif %}
                
                {% if resume.bank_account %}
                    <div><strong>شماره حساب بانکی: IR </strong> {{ resume.bank_account }}</div>
                {% endif %}
                
                {% if resume.file %}
                    <div><strong>فایل رزومه:</strong> 
                        <a href="{{ resume.file.url }}" target="_blank" class="file-link">مشاهده فایل</a>
                    </div>
                {% endif %}
            </div>

            <!-- مجوزها -->
            {% if permissions %}
                <div class="info-section">
                    <h4>مجوزها و گواهی‌نامه‌ها ({{ permissions.count }})</h4>
                    <ul class="permissions-list">
                        {% for permission in permissions %}
                            <li>
                                <strong>{{ permission.title }}</strong>
                                {% if permission.description %}
                                    <p>{{ permission.description }}</p>
                                {% endif %}
                                {% if permission.issue_date %}
                                    <small>تاریخ صدور: {{ permission.issue_date }}</small>
                                {% endif %}
                                {% if permission.expiry_date %}
                                    <small> | تاریخ انقضا: {{ permission.expiry_date }}</small>
                                    {% if permission.is_expired %}
                                        <span style="color: red; font-weight: bold;"> (منقضی شده)</span>
                                    {% endif %}
                                {% endif %}
                                <br>
                                <a href="{{ permission.file.url }}" target="_blank" class="file-link">مشاهده فایل</a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            <!-- لینک‌های نمونه کار -->
            {% if work_links %}
                <div class="info-section">
                    <h4>لینک‌های نمونه کارها ({{ work_links.count }})</h4>
                    <ul class="worklinks-list">
                        {% for link in work_links %}
                            <li>
                                <strong>{{ link.title }}</strong>
                                {% if link.is_featured %}
                                    <span style="color: gold;">⭐ برجسته</span>
                                {% endif %}
                                {% if link.description %}
                                    <p>{{ link.description }}</p>
                                {% endif %}
                                {% if link.category %}
                                    <small>دسته‌بندی: {{ link.category }}</small>
                                {% endif %}
                                {% if link.completion_date %}
                                    <small> | تاریخ تکمیل: {{ link.completion_date }}</small>
                                {% endif %}
                                <br>
                                <a href="{{ link.url }}" target="_blank" class="file-link">{{ link.url }}</a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            <!-- فرم بررسی مدیر -->
            <div class="review-form">
                <h3>بررسی و تصمیم‌گیری</h3>
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="field-row">
                        <div>
                            <label for="id_status">تغییر وضعیت:</label>
                            {{ form.status }}
                        </div>
                    </div>
                    
                    <div>
                        <label for="id_manager_comment">نظر مدیر:</label>
                        {{ form.manager_comment }}
                        <small class="text-muted">{{ form.manager_comment.help_text }}</small>
                    </div>
                    
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">ثبت تصمیم</button>
                        <a href="{% url 'account:review_resumes' %}" class="btn btn-secondary">بازگشت</a>
                    </div>
                </form>
            </div>
            </div>  {# پایان resume-scroll-wrapper #}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusSelect = document.getElementById('id_status');
    const commentField = document.getElementById('id_manager_comment');
    
    // اجباری کردن کامنت برای وضعیت‌های خاص
    statusSelect.addEventListener('change', function() {
        const requiresComment = ['needs_editing', 'rejected'];
        
        if (requiresComment.includes(this.value)) {
            commentField.required = true;
            commentField.placeholder = 'توضیحات الزامی است - لطفاً دلیل تصمیم خود را بنویسید';
            commentField.style.borderColor = '#dc3545';
        } else {
            commentField.required = false;
            commentField.placeholder = 'نظر یا توضیحات مدیر در مورد رزومه...';
            commentField.style.borderColor = '#ced4da';
        }
    });
    
    // تریگر کردن event برای مقدار اولیه
    statusSelect.dispatchEvent(new Event('change'));
});
</script>

{% endblock %}

