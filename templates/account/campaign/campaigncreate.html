{% extends "account/account_base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% block title %}ایجاد کمپین‌ تبلیغاتی{% endblock %}

{% block extra_head %}
<link href="{% static 'account/build/css/campaign_style.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<style>
/* scrollable frame for content */
  .content-frame {
    max-height: calc(100vh - 140px);
    overflow-y: auto;
    overflow-x: hidden;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    background: #fff;
    padding: 1rem;
    -webkit-overflow-scrolling: touch;
  }
  @media (max-width: 576px) {
    .content-frame { max-height: calc(100vh - 110px); padding: .75rem; }
  }

.topic-card-list {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    justify-content: center;
}

.topic-card {
    position: relative;
    width: calc(33.33% - 10px);
    border: 2px solid #ddd;
    border-radius: 10px;
    padding: 15px;
    cursor: pointer;
    text-align: center;
    transition: all 0.3s ease;
    background-color: #fff;
}

/* استایل در حالت انتخاب‌شده */
.topic-card.selected {
    box-shadow: 0 0 10px rgba(235, 237, 235, 0.3);
    
}
.topic-card .icon-wrapper {
    width: 50px;
    height: 50px;
    border-radius: 10px;
    margin: 0 auto 10px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.topic-card img {
    width: 30px;
    height: 30px;
}

.topic-card h4 {
    font-weight: bold;
    margin-bottom: 5px;
}

.topic-card p {
    font-size: 12px;
    color: #555;
    line-height: 1.5;
    min-height: 38px;
}

.topic-card .checkmark {
    position: absolute;
    top: 10px;
    left: 10px;
    font-size: 18px;
    color: green;
    display: none;
}

.topic-card.selected .checkmark {
    display: block;
}

.topic-card .info-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 16px;
    cursor: pointer;
}

/* نمایش 2 کارت در ردیف برای تبلت */
@media (max-width: 992px) {
    .topic-card {
        width: calc(50% - 10px);
    }
}

/* نمایش 1 کارت در ردیف برای موبایل */
@media (max-width: 576px) {
    .topic-card {
        width: 100%;
    }
}

</style>

<div class="content-frame">
<div class="container-fluid" style="scale:90%;">
    <div class="row">
        <!-- فرم اصلی -->
        <div class="col-md-7 col-xs-12">
            <div class="x_panel">
                <div class="x_title">
                    <h2 style="color: #028c32;">ایجاد کمپین‌ جدید</h2>
                    <div class="clearfix"></div>
                </div>
                <form method="post" enctype="multipart/form-data novalidate" >
                    {% csrf_token %}
                    
                    {# Render customer field if it exists #}
                    {% if form.customer %}
                        <div class="form-group customer-field">
                            {% if user.is_staff or user.is_am %}
                            <label for="{{ form.customer.id_for_label }}">مشتری:</label>
                            {% endif%}
                            {{ form.customer }}
                            {% if form.customer.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.customer.errors }}
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}

                    {# Custom topic checkbox rendering #}
                    <div class="form-group">
                        <label for="id_topic">دسته‌بندی کمپین:</label>
                        <div class="topic-card-list">
                            {% for topic in form.fields.topic.queryset %}
                            <div class="topic-card {% if topic.id in form.topic.value %}selected{% endif %}" 
                                 data-id="{{ topic.id }}" 
                                 data-description="{{ topic.description|default:'' }}"
                                 data-color="{{ topic.color }}">
                                <div class="icon-wrapper">
                                    <img src="{{ topic.icon.url }}" alt="{{ topic.name }}" />
                                </div>
                                <h4>{{ topic.name }}</h4>
                                <p class="short-description">{{ topic.short_description }}</p>
                                <!-- اضافه کردن توضیحات ریزتر -->
                                <div class="detailed-description">
                                    {{ topic.short_describe|default:"توضیحات تکمیلی اینجا نمایش داده می‌شود" }}
                                </div>
                                <span class="info-btn" title="اطلاعات بیشتر">ℹ️</span>
                                <div class="checkmark">✔</div>
                            </div>
                            {% endfor %}
                        </div>
                        <input type="hidden" name="topic" id="selected-topic-id" value="{{ form.topic.value.0 }}">
                    </div>


                    <div class="form-group">
                        <label for="id_topic">شرح کمپین:</label>{# Render describe field #}
                        {{ form.describe }}
                        {% if form.describe.errors %}
                            <div class="invalid-feedback d-block text-danger">
                                {{ form.describe.errors }}
                            </div>
                        {% endif %}
                    </div>
                    {# Render purposed_price field #}
                    <div class="form-group">
                        <label for="id_topic">قیمت پیشنهادی:</label>{# Render describe field #}
                        {{ form.purposed_price }}
                        {% if form.purposed_price.errors %}
                            <div class="invalid-feedback d-block text-danger">
                                {{ form.purposed_price.errors }}
                            </div>
                        {% endif %}
                    </div>

                    {# Campaign images #}
                    {{ image_formset.management_form }}
                    <div id="image-form-container">
                        {% for image_form in image_formset %}
                            <div class="image-form">
                                {{ image_form|crispy }}
                            </div>
                        {% endfor %}
                    </div>

                    <button type="button" id="add-image-form" class="btn btn-info">افزودن تصویر</button>

                    <div class="form-group">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="rules_accepted" name="rules_accepted" >
                            <label class="custom-control-label" for="rules_accepted">
                                قوانین و مقررات را مطالعه کرده و می‌پذیرم
                            </label>
                        </div>
                    </div>

                    <br><br>

                    <a href="{% url 'account:campaigns' %}" class="btn btn-primary">بازگشت</a>
                    <button type="submit" class="btn btn-success">ایجاد کمپین</button>
                
            </div>
        </div>

        <!-- قوانین و مقررات -->
        <div class="col-md-5 col-xs-12">
            <div class="x_panel">
                <div class="x_title">
                    <h2 style="color: #028c32;">قوانین و مقررات</h2>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                    <div class="rules-container">
                        <ul class="rules-list">
                            <li>لطفا توضیحات کمپین را به صورت کامل وارد نمایید.</li>
                            <li>قیمت پیشنهادی باید منطقی و متناسب با خدمات درخواستی باشد.</li>
                            <li>تصاویر آپلود شده باید با کیفیت و مرتبط با موضوع کمپین باشند.</li>
                            <!-- سایر قوانین را اینجا اضافه کنید -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- افزودن پنل جدید برای توضیحات موضوع -->
            <div class="x_panel">
                <div class="x_title">
                    <h2 style="color: #028c32;">توضیحات موضوع</h2>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                    <div id="topic-description-container">
                        <p class="text-muted">لطفاً یک موضوع را انتخاب کنید.</p>
                    </div>
                </div>
            </div>
        </div>
    </form>
    </div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/autonumeric@4.6.0/dist/autoNumeric.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
    const cards = document.querySelectorAll(".topic-card");
    const hiddenInput = document.getElementById("selected-topic-id");
    const form = document.querySelector("form");
    const rulesCheckbox = document.getElementById("rules");
    const descriptionContainer = document.getElementById("topic-description-container");

    function resetCardStyles() {
    cards.forEach(card => {
        card.classList.remove("selected");
        card.style.borderColor = "#ddd";  // ← بازگرداندن به حالت اولیه
        card.style.backgroundColor = "#fff"; // ← در صورت نیاز
            });
        }

    function showModal(title, message) {
        const modalHtml = `
            <div class="modal fade" id="customModal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${title}</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">${message}</div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-dismiss="modal">متوجه شدم</button>
                        </div>
                    </div>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        $('#customModal').modal('show');
        $('#customModal').on('hidden.bs.modal', function () {
            $(this).remove();
        });
    }

    cards.forEach(card => {
        card.addEventListener("click", () => {
                        resetCardStyles();
                        card.classList.add("selected");
                        const color = card.dataset.color || "#2ecc71";
                        card.style.borderColor = color;
                        hiddenInput.value = card.dataset.id;
                        const description = card.dataset.description || "توضیحاتی برای این موضوع ثبت نشده است.";
                        if (descriptionContainer) {
                            descriptionContainer.innerHTML = `<p>${description}</p>`;
                        }
                    });

        const infoBtn = card.querySelector(".info-btn");
        if (infoBtn) {
            infoBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                alert(card.dataset.description || "توضیحاتی برای این دسته موجود نیست.");
            });
        }

        if (card.classList.contains("selected")) {
            const color = card.dataset.color || "#f0fff5";
            card.style.backgroundColor = color;
        }
    });

    form.addEventListener("submit", function (e) {
        const selectedTopicId = hiddenInput.value;
        if (!selectedTopicId) {
            e.preventDefault();
            showModal("توجه", "لطفاً یک موضوع برای کمپین انتخاب کنید");
            return;
        }

        if (!rulesCheckbox.checked) {
            e.preventDefault();
            showModal("توجه", "برای ایجاد کمپین جدید باید قوانین را تایید کنید");
            return;
        }
    });
});

</script>

{% endblock %}

