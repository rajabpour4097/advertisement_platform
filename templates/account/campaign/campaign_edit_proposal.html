{% extends "account/account_base.html" %}
{% load static %}
{% load advplatform_tags %}
{% load account_tags %}

{% block title %}ویرایش پیشنهاد کمپین{% endblock %}

{% block extra_head %}
{% if ad_kind == "environmental" %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
  #env-map { height: 350px; width: 700px; border: 1px solid #ddd; border-radius: 6px; }
</style>
{% endif %}
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-12 col-sm-12 col-xs-12">
    <div class="x_panel">
      <div class="x_title" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
        <h3 class="x_title" style="margin:0;font-size:18px;line-height:1.6;">
          ویرایش پیشنهاد برای کمپین:
          <span class="text-primary">{{ campaign.describe|default:"-" }}</span>
        </h3>

        {% if ad_kind == "environmental" %}
          <span class="label label-info">تبلیغ محیطی</span>
        {% elif ad_kind == "socialmedia" %}
          <span class="label label-info">تبلیغ شبکه‌های اجتماعی</span>
        {% elif ad_kind == "digital" %}
          <span class="label label-info">تبلیغ دیجیتال</span>
        {% elif ad_kind == "printing" %}
          <span class="label label-info">تبلیغ چاپی</span>
        {% elif ad_kind == "event" %}
          <span class="label label-info">ایونت مارکتینگ</span>
        {% else %}
          <span class="label label-warning">فرم عمومی</span>
        {% endif %}

        <div class="clearfix"></div>
      </div>

      <div class="x_content">
        {# خلاصه خطاها #}
        {% if form.non_field_errors %}
          <div class="alert alert-danger">
            {{ form.non_field_errors }}
          </div>
        {% endif %}

        <form method="post" enctype="multipart/form-data" class="form-horizontal form-label-left">
          {% csrf_token %}

          {% if ad_kind == "environmental" %}
            {# فیلدهای مخفی #}
            {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}

            {# شبکه‌ی دو ستونه برای فیلدها (به‌جز توضیحات و مختصات) #}
            <div class="row">
              {% for field in form.visible_fields %}
                {% if field.name != 'description' and field.name != 'media_location_latitude' and field.name != 'media_location_longitude' %}
                  <div class="col-md-6 col-sm-6 col-xs-12">
                    <div class="form-group">
                      <label for="{{ field.id_for_label }}" class="control-label">{{ field.label }}</label>
                      {{ field }}
                      {% if field.help_text %}<p class="help-block">{{ field.help_text }}</p>{% endif %}
                      {% if field.errors %}<div class="text-danger small">{{ field.errors }}</div>{% endif %}
                    </div>
                  </div>
                {% endif %}
              {% endfor %}
            </div>

            {# نقشه و انتخاب موقعیت #}
            <div class="well" style="padding:16px 16px 10px;">
              <div class="clearfix" style="margin-bottom:8px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
                <h4 style="margin:0;font-size:15px;">انتخاب موقعیت مکانی</h4>
                <button type="button" id="locateMeBtn" class="btn btn-xs btn-default">
                  <i class="fa fa-location-arrow"></i> یافتن موقعیت من
                </button>
                <small id="coordsInfo" class="text-muted">مختصات انتخاب‌شده: -</small>
              </div>

              <div id="env-map" style="height:350px;width:100%;border:1px solid #e5e7eb;border-radius:6px;"></div>

              {# فیلدهای مختصات (پنهان یا رندر خود فرم) #}
              <div class="row" style="margin-top:10px;">
                <div class="col-sm-6">
                  {% if form.media_location_latitude %}{{ form.media_location_latitude }}{% endif %}
                </div>
                <div class="col-sm-6">
                  {% if form.media_location_longitude %}{{ form.media_location_longitude }}{% endif %}
                </div>
              </div>
            </div>

            {# توضیحات #}
            {% if form.description %}
              <div class="form-group">
                <label for="{{ form.description.id_for_label }}" class="control-label">توضیحات</label>
                {{ form.description }}
                {% if form.description.errors %}<div class="text-danger small">{{ form.description.errors }}</div>{% endif %}
              </div>
            {% endif %}

          {% else %}
            {# حالت‌های غیرمحیطی: نمایش تمیز داخل کارت #}
            <div class="row">
              <div class="col-md-10 col-sm-12">
                <div class="panel panel-default">
                  <div class="panel-body">
                    {{ form.as_p }}
                  </div>
                </div>
              </div>
            </div>
          {% endif %}

          <div class="ln_solid"></div>
          <div class="form-group" style="display:flex;gap:8px;justify-content:flex-start;flex-wrap:wrap;">
            <button type="submit" class="btn btn-warning">
              <i class="fa fa-save"></i> ثبت ویرایش
            </button>
            <a href="{% url 'account:campaigns' %}" class="btn btn-default">
              <i class="fa fa-arrow-right"></i> بازگشت
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{% if ad_kind == "environmental" %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
  (function () {
    const latInput = document.getElementById('id_media_location_latitude');
    const lonInput = document.getElementById('id_media_location_longitude');
    const coordsInfo = document.getElementById('coordsInfo');

    const provinceSelect = document.getElementById('id_province');
    const citySelect = document.getElementById('id_city');

    async function loadCities(provinceId, selectedId) {
      if (!citySelect) return;
      citySelect.innerHTML = '';
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'انتخاب شهر';
      citySelect.appendChild(opt);
      if (!provinceId) return;
      try {
        const resp = await fetch("{% url 'account:ajax_cities' %}?province_id=" + encodeURIComponent(provinceId));
        const data = await resp.json();
        (data.results || []).forEach(function (c) {
          const o = document.createElement('option');
          o.value = c.id;
          o.textContent = c.name;
          if (selectedId && String(selectedId) === String(c.id)) o.selected = true;
          citySelect.appendChild(o);
        });
      } catch (e) { console.error(e); }
    }

    if (provinceSelect && citySelect) {
      const initialProvince = provinceSelect.value;
      const initialCity = citySelect.getAttribute('value') || citySelect.value || '';
      if (initialProvince) {
        loadCities(initialProvince, initialCity);
      }
      provinceSelect.addEventListener('change', function () {
        loadCities(this.value, '');
      });
    }

    let initLat = parseFloat(latInput?.value) || 35.6892;
    let initLon = parseFloat(lonInput?.value) || 51.3890;
    let initZoom = (latInput?.value && lonInput?.value) ? 14 : 6;

    const map = L.map('env-map', { center: [initLat, initLon], zoom: initZoom });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let marker = L.marker([initLat, initLon], { draggable: true }).addTo(map);

    function updateInputs(latlng) {
      if (!latInput || !lonInput) return;
      latInput.value = latlng.lat.toFixed(6);
      lonInput.value = latlng.lng.toFixed(6);
      if (coordsInfo) coordsInfo.textContent = `مختصات انتخاب‌شده: ${latInput.value}, ${lonInput.value}`;
    }
    updateInputs({ lat: initLat, lng: initLon });

    map.on('click', function (e) { marker.setLatLng(e.latlng); updateInputs(e.latlng); });
    marker.on('dragend', function (e) { updateInputs(e.target.getLatLng()); });

    const locateBtn = document.getElementById('locateMeBtn');
    if (locateBtn && navigator.geolocation) {
      locateBtn.addEventListener('click', function () {
        navigator.geolocation.getCurrentPosition(function (pos) {
          const ll = L.latLng(pos.coords.latitude, pos.coords.longitude);
          map.setView(ll, 15); marker.setLatLng(ll); updateInputs(ll);
        }, function () { alert('امکان دریافت موقعیت شما وجود ندارد.'); }, { enableHighAccuracy: true, timeout: 8000 });
      });
    }
  })();
</script>
{% endif %}
{% endblock %}

