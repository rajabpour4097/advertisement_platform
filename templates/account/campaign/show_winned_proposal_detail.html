{% extends "account/account_base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% load advplatform_tags %}
{% load account_tags %}
{% load humanize %}

{% block title %}جزئیات پیشنهاد طرح برنده{% endblock %}

{% block extra_head %}
<link href="{% static 'account/build/css/campaign_style.css' %}" rel="stylesheet">
{% if proposal.kind == 'environmental' %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
{% endif %}
{% endblock %}

{% block content %}
<style>
    /* scrollable frame for content */
      .content-frame {
        max-height: calc(100vh - 140px);
        overflow-y: auto;
        overflow-x: hidden;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        background: #fff;
        padding: 1rem;
        -webkit-overflow-scrolling: touch;
      }
      @media (max-width: 576px) {
        .content-frame { max-height: calc(100vh - 110px); padding: .75rem; }
      }
    .winner-wrapper {max-width: 950px;margin: 0 auto;padding: 1.5rem;}
    .winner-header {display:flex;align-items:center;gap:12px;margin-bottom:1rem;}
    .winner-header h2 {color:#028c32;margin:0;font-size:1.92rem;font-weight:700;}
    .kind-environmental {background:#dcfce7;color:#166534;}
    .kind-social {background:#dbeafe;color:#1d4ed8;}
    .kind-digital {background:#fef9c3;color:#92400e;}
    .kind-printing {background:#fde68a;color:#92400e;}
    .kind-event {background:#fbcfe8;color:#9d174d;}
    .winner-grid {display:grid;grid-template-columns:1fr;gap:1.25rem;}
    .winner-card {background:#ffffff;border:1px solid #e2e8f0;border-radius:16px;padding:1.25rem 1.5rem;box-shadow:0 4px 10px rgba(0,0,0,.04);position:relative;    overflow:hidden;}
    .winner-card:before {content:"";position:absolute;inset:0;background:linear-gradient(135deg,rgba(2,140,50,0.08),rgba(2,140,50,0) 60%);pointer-events:none;}
    .winner-card-header {display:flex;flex-direction:column;gap:4px;margin-bottom:1rem;}
    .participant-label {background:#028c32;color:#fff;padding:4px 10px;border-radius:12px;font-size:15px;align-self:flex-start;}
    .winner-meta {display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:.65rem .75rem;margin-bottom:1rem;font-size:1.02rem;}
    .winner-meta div {background:#f8fafc;padding:8px 10px;border-radius:10px;border:1px solid #eef2f7;min-height:42px;display:flex;align-items:center;}
    .winner-meta strong {color:#374151;margin-left:4px;font-weight:600;}
    .winner-proposal h4 {font-size:1.2rem;margin:0 0 .5rem;font-weight:700;color:#028c32;}
    .winner-proposal {background:#f1f5f9;border:1px solid #e2e8f0;padding:14px 16px;border-radius:14px;margin-bottom:1rem;}
    .proposal-text {white-space:pre-wrap;line-height:1.7;font-size:1.08rem;color:#334155;margin:0;}
    .actions {display:flex;gap:.75rem;}
    .actions .btn {border-radius:10px;font-size:.96rem;font-weight:600;}
    @media (max-width:640px){.winner-meta{grid-template-columns:1fr}.winner-card{padding:1rem}.winner-header h2{font-size:1.56rem}}
</style>
<div class="content-frame">
    <div class="winner-wrapper">
        <div class="winner-header">
            <h2>برنده کمپین</h2>
        </div>
        <div class="winner-grid">
            <div class="winner-card">
                <div class="winner-card-header">
                    <span class="participant-label">{{ proposal.dealer.get_full_name }}</span>
                </div>
                <div class="winner-meta">
                    <div><strong>کمپین:</strong> {{ campaign.get_describe_summrize }}</div>
                    <div><strong>موضوعات:</strong> {% for t in campaign.topic.all %}{{ t.name }}{% if not forloop.last %}, {% endif %}{% empty %}-{% endfor %}</div>
                    <div><strong>تاریخ ثبت پیشنهاد:</strong> {{ proposal.created_at|jalali_timedate }}</div>
                    <div><strong>قیمت پیشنهادی:</strong> {{ proposal.proposal_price|format_price }}</div>
                </div>
                <div class="winner-proposal">
                    <h4>متن پیشنهاد</h4>
                    <p class="proposal-text">{{ proposal.proposals|linebreaksbr }}</p>
                        {% if proposal.kind == 'environmental' %}
                            <div class="mt-3">
                                <h5>جزئیات تبلیغ محیطی</h5>
                                <ul style="padding-right:18px;line-height:1.9;font-size:.95em;">
                                    <li>عنوان موقعیت: {{ proposal.raw_obj.location_title }}</li>
                                    <li>نوع رسانه: {{ proposal.raw_obj.get_media_type_display }}</li>
                                    <li>ابعاد رسانه: {{ proposal.raw_obj.media_width }} × {{ proposal.raw_obj.media_height }}</li>
                                    <li>تاریخ شروع: {{ proposal.raw_obj.available_date | jalali_date }}</li>
                                    <li>مدت اکران (روز): {{ proposal.raw_obj.expiration_date }}</li>
                                    <li>موقعیت روی نقشه:</li>
                                </ul>
                                {# تصاویر موقعیت #}
                                    {% with imgs=proposal.raw_obj.images.all %}
                                        <div class="mb-3">
                                            <strong style="font-size:.9rem;">تصاویر موقعیت:</strong>
                                                {% if imgs %}
                                                    <div class="d-flex flex-wrap gap-2 mt-2">
                                                        {% for img in imgs %}
                                                            <div style="width:110px;">
                                                                <img src="{{ img.image.url }}" alt="{{ img.caption|default:'image' }}" style="width:100%;height:90px;object-fit:cover;border:1px solid #e5e7eb;border-radius:6px;cursor:pointer;" onclick="openEnvImageModal('{{ img.image.url }}','{{ img.caption|default:'' }}')">
                                                                {% if img.caption %}
                                                                    <div class="small text-muted mt-1" style="font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">{{ img.caption }}
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% else %}
                                                    <div class="text-muted small mt-2">تصویری ثبت نشده است.</div>
                                                {% endif %}
                                        </div>
                                    {% endwith %}
                                <div id="env-map" style="width:100%;height:260px;border:1px solid #e2e8f0;border-radius:12px;overflow:hidden;display:none;"></div>
                            </div>
                            {% elif proposal.kind == 'social' %}
                            <div class="mt-3">
                                <h5>جزئیات تبلیغ شبکه اجتماعی</h5>
                                <ul style="padding-right:18px;line-height:1.9;font-size:.95em;">
                                    <li>نوع رسانه: {{ proposal.raw_obj.get_proposed_ad_template_display }}</li>
                                    <li>شروع: {{ proposal.raw_obj.start_execution_time|date:'Y-m-d H:i' }}</li>
                                    <li>پایان: {{ proposal.raw_obj.end_execution_time|date:'Y-m-d H:i' }}</li>
                                    <li>دسته‌های محتوا: {% for c in proposal.raw_obj.content_categories.all %}{{ c.name }}{% if not forloop.last %}, {% endif %}{empty     %}-{% endfor %}</li>
                                </ul>
                            </div>
                            {% elif proposal.kind == 'digital' %}
                            <div class="mt-3">
                                <h5>جزئیات تبلیغ دیجیتال</h5>
                                <ul style="padding-right:18px;line-height:1.9;font-size:.95em;">
                                    <li>نوع رسانه: {{ proposal.raw_obj.get_digital_ad_type_display }}</li>
                                    <li>نوع هدف‌گذاری: {{ proposal.raw_obj.get_targeting_type_display }}</li>
                                    <li>تخمین کلیک/نمایش: {{ proposal.raw_obj.estimated_clicks|intcomma }}</li>
                                    <li>مدت (روز): {{ proposal.raw_obj.duration }}</li>
                                    <li>بودجه تبلیغ: {{ proposal.raw_obj.advertising_budget|intcomma }} تومان</li>
                                    <li>پلتفرم‌ها: {% for p in proposal.raw_obj.proposed_platform.all %}{{ p.name }}{% if not forloop.last %}, {% endif %}{% empty -{%     endfor %}</li>
                                </ul>
                            </div>
                            {% elif proposal.kind == 'printing' %}
                            <div class="mt-3">
                                <h5>جزئیات تبلیغ چاپی</h5>
                                <ul style="padding-right:18px;line-height:1.9;font-size:.95em;">
                                    <li>نوع اقلام: {{ proposal.raw_obj.get_printing_ad_type_display }}</li>
                                    <li>گرماژ و جنس کاغذ: {{ proposal.raw_obj.paper_weight_and_type }}</li>
                                    <li>ابعاد: {{ proposal.raw_obj.dimensions }}</li>
                                    <li>تیراژ: {{ proposal.raw_obj.circulation|intcomma }}</li>
                                    <li>زمان تحویل (روز کاری): {{ proposal.raw_obj.delivery_time }}</li>
                                    <li>طراحی گرافیکی: {{ proposal.raw_obj.graphic_design_included|yesno:'بله,خیر' }}</li>
                                </ul>
                            </div>
                            {% elif proposal.kind == 'event' %}
                            <div class="mt-3">
                                <h5>جزئیات ایونت مارکتینگ</h5>
                                <ul style="padding-right:18px;line-height:1.9;font-size:.95em;">
                                    <li>نوع رویداد: {{ proposal.raw_obj.get_event_type_display }}</li>
                                    <li>شهر: {{ proposal.raw_obj.location }}</li>
                                    <li>آدرس محل: {{ proposal.raw_obj.location_address }}</li>
                                    <li>تاریخ پیشنهادی: {{ proposal.raw_obj.event_proposed_date }}</li>
                                    <li>سناریو رویداد: {{ proposal.raw_obj.event_content|default:'-' }}</li>
                                </ul>
                            </div>
                        {% endif %}
                </div>
                <div class="winner-proposal">
                    <h4>مشخصات کاربر برنده</h4>
                    <div class="winner-meta">
                        <div><strong>شماره تماس:</strong> {{ campaign.campaign_dealer.phone_number }}</div>
                        <div><strong>ایمیل:</strong> {{ campaign.campaign_dealer.email }}</div>
                    </div>

                </div>
                <div class="actions">
                    <a href="{% url 'account:campaigns' %}" class="btn btn-secondary btn-sm">بازگشت به کمپین ها</a>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{% if proposal.kind == 'environmental' %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
// modal for viewing environmental images fullscreen
(function(){
    if(!document.getElementById('envImageModal')){
        const modal=document.createElement('div');
        modal.id='envImageModal';
        modal.style.cssText='position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:1050;padding:20px;';
        modal.innerHTML=`<div style="max-width:720px;width:100%;">
                <div style="background:#fff;border-radius:8px;overflow:hidden;position:relative;">
                    <button type="button" id="envImageModalClose" style="position:absolute;top:6px;left:6px;background:#0008;color:#fff;border:none;border-radius:4px;padding:4px 8px;font-size:12px;cursor:pointer;">×</button>
                    <img id="envImageModalImg" src="" alt="" style="width:100%;height:auto;display:block;max-height:70vh;object-fit:contain;background:#000;">
                    <div id="envImageModalCaption" style="padding:8px 12px;font-size:12px;color:#555;white-space:pre-wrap;"></div>
                </div>`;
        document.body.appendChild(modal);
        modal.addEventListener('click', e=>{ if(e.target===modal || e.target.id==='envImageModalClose'){ modal.style.display='none'; }});
        window.openEnvImageModal = function(src, cap){
            const imgEl=document.getElementById('envImageModalImg');
            const capEl=document.getElementById('envImageModalCaption');
            imgEl.src=src; capEl.textContent=cap||''; modal.style.display='flex';
        }
    }
})();
document.addEventListener('DOMContentLoaded', function(){
    const latRaw = "{{ proposal.raw_obj.media_location_latitude|default_if_none:'' }}";
    const lonRaw = "{{ proposal.raw_obj.media_location_longitude|default_if_none:'' }}";
    const lat = parseFloat(latRaw);
    const lon = parseFloat(lonRaw);
    if(Number.isFinite(lat) && Number.isFinite(lon)){
         const mapDiv = document.getElementById('env-map');
         if(mapDiv){
                mapDiv.style.display='block';
                setTimeout(function(){ // ensure visible & sized
                    const map = L.map('env-map',{center:[lat,lon],zoom:14,scrollWheelZoom:false});
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
                    L.marker([lat,lon]).addTo(map);
                },0);
         }
    }
});
</script>
{% endif %}
{% endblock %}
