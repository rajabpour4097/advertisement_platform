{% extends "account/account_base.html" %}
{% load static %}
{% load advplatform_tags %}
{% load account_tags %}

{% block title %}جزئیات پیشنهاد{% endblock %}

{% block extra_head %}
{% if kind == 'environmental' %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
  #env-map { height: 350px; width: 700px; border: 1px solid #ddd; border-radius: 6px; }
</style>
{% endif %}
{% endblock %}

{% block content %}
<div class="x_panel">
  <div class="x_title">
    <h2>جزئیات پیشنهاد</h2>
    <div class="nav navbar-right">
      <a href="javascript:history.back();" class="btn btn-secondary">
        <i class="fa fa-arrow-right"></i> بازگشت
      </a>
    </div>
    <div class="clearfix"></div>
  </div>

  <div class="x_content">
    <div class="row">
      <div class="col-md-6">
        <div class="mb-2"><strong>نوع پیشنهاد:</strong>
          <span class="badge bg-info">
            {% if kind == 'environmental' %}محیطی
            {% elif kind == 'socialmedia' %}شبکه‌های اجتماعی
            {% elif kind == 'digital' %}دیجیتال
            {% elif kind == 'printing' %}چاپی
            {% elif kind == 'event' %}ایونت مارکتینگ
            {% else %}عمومی{% endif %}
          </span>
        </div>
        {% if campaign %}
        <div class="mb-2"><strong>کمپین:</strong> {{ campaign.describe|default:campaign }}</div>
        {% endif %}
        <div class="mb-2"><strong>کاربر برگزارکننده:</strong> {{ campaign.customer.get_full_name|default:user.username }}</div>
        {% if user %}
        <div class="mb-2"><strong>کاربر پیشنهاد دهنده:</strong> {{ user.get_full_name|default:user.username }}</div>
        {% endif %}
      </div>
      <div class="col-md-6 text-start">
        <div class="mb-2"><strong>قیمت پیشنهادی:</strong>
          <span class="price-column">{{ price|default:0|format_price }}</span>
        </div>
      </div>
    </div>

    <hr>

    <div class="mb-3">
      <strong>توضیحات/متن:</strong>
      <p style="white-space: pre-line">{{ text|default:"-" }}</p>
    </div>

    {% if kind == 'environmental' %}
    <div class="mb-3" id="env-map-wrap" style="display:none">
      <h5 class="mt-2 mb-2">موقعیت مکانی</h5>
      <div id="env-map"></div>
    </div>
    {% endif %}

    <h5 class="mt-4">سایر جزئیات</h5>
    <div class="table-responsive">
      <table class="table table-striped">
        <tbody>
          {% for item in details %}
          {% if item.value %}
          <tr>
            <th style="width: 250px">{{ item.label }}</th>
            <td>
              {% if item.is_dt %}
                {{ item.value|jalali_timedate }}
              {% else %}
                {{ item.value }}
              {% endif %}
            </td>
          </tr>
          {% endif %}
          {% empty %}
          <tr><td colspan="2">جزئیات دیگری ثبت نشده است.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% if kind == 'environmental' %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
  (function () {
    // مختصات از شیء پیشنهاد (اگر موجود باشد)
    const latRaw = "{{ obj.media_location_latitude|default_if_none:'' }}";
    const lonRaw = "{{ obj.media_location_longitude|default_if_none:'' }}";
    const lat = parseFloat(latRaw);
    const lon = parseFloat(lonRaw);

    if (Number.isFinite(lat) && Number.isFinite(lon)) {
      const wrap = document.getElementById('env-map-wrap');
      if (wrap) wrap.style.display = '';

      const map = L.map('env-map', {
        center: [lat, lon],
        zoom: 14,
        zoomControl: true,
        dragging: true,           // اجازه جابه‌جایی نقشه (اختیاری)
        scrollWheelZoom: false,   // جلوگیری از اسکرول ناخواسته صفحه
        doubleClickZoom: true,
        boxZoom: false,
        keyboard: false
      });

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // مارکر فقط برای نمایش (غیرقابل‌کشیدن)
      L.marker([lat, lon], { draggable: false }).addTo(map);
    }
  })();
</script>
{% endif %}
{% endblock %}