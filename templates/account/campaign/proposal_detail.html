{% extends "account/account_base.html" %}
{% load static %}
{% load advplatform_tags %}
{% load account_tags %}

{% block title %}جزئیات پیشنهاد{% endblock %}

{% block extra_head %}
{% if kind == 'environmental' %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
  #env-map { height: 350px; width: 700px; border: 1px solid #ddd; border-radius: 6px; }
</style>
{% endif %}
{% endblock %}

{% block content %}
<div class="x_panel">
  <div class="x_title" style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
      <h2 class="mb-0" style="font-size:18px;">جزئیات پیشنهاد</h2>
      <span class="label label-info" style="font-size:12px;">
        {% if kind == 'environmental' %}محیطی
        {% elif kind == 'socialmedia' %}شبکه‌های اجتماعی
        {% elif kind == 'digital' %}دیجیتال
        {% elif kind == 'printing' %}چاپی
        {% elif kind == 'event' %}ایونت مارکتینگ
        {% else %}عمومی{% endif %}
      </span>
      {% if campaign %}
        <span class="label label-default" style="font-size:12px;">کمپین: {{ campaign.describe|default:campaign }}</span>
      {% endif %}
    </div>

    <a href="javascript:history.back();" class="btn btn-default btn-sm">
      <i class="fa fa-arrow-right"></i> بازگشت
    </a>
    <div class="clearfix"></div>
  </div>

  <div class="x_content">
    <!-- meta row -->
    <div class="row">
      <div class="col-md-7 col-sm-7">
        <ul class="list-unstyled" style="margin:0;">
          {% if campaign %}
          <li class="mb-2">
            <strong>کمپین:</strong>
            <span class="text-primary">{{ campaign.describe|default:campaign }}</span>
          </li>
          {% endif %}

          <li class="mb-2">
            <strong>کاربر برگزارکننده:</strong>
            <span>{{ campaign.customer.get_full_name|default:user.username }}</span>
          </li>

          {% if user %}
          <li class="mb-2">
            <strong>کاربر پیشنهاددهنده:</strong>
            <span>{{ user.get_full_name|default:user.username }}</span>
          </li>
          {% endif %}
        </ul>
      </div>

      <div class="col-md-5 col-sm-5 text-start">
        <div class="well" style="padding:10px 12px;display:inline-block;margin:0;">
          <strong>قیمت پیشنهادی:</strong>
          <span class="price-column text-success" style="font-weight:700;">
            {{ price|default:0|format_price }}
          </span>
        </div>
      </div>
    </div>

    <hr>

    <!-- description -->
    <div class="mb-3">
      <strong>توضیحات / متن:</strong>
      <div class="panel panel-default" style="margin-top:8px;">
        <div class="panel-body" style="white-space:pre-line; font-size:13px; color:#4b5563;">
          {{ text|default:"-" }}
        </div>
      </div>
    </div>

    {% if kind == 'environmental' %}
    <!-- map -->
    <div class="mb-3" id="env-map-wrap" style="display:none">
      <h4 class="mt-0 mb-10" style="font-size:15px;">موقعیت مکانی</h4>
      <div id="env-map" style="height:360px;width:100%;border:1px solid #e5e7eb;border-radius:8px;"></div>
    </div>
    {% endif %}

    <!-- details table -->
    <h4 class="mt-4" style="font-size:15px;">سایر جزئیات</h4>
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <tbody>
        {% for item in details %}
          {% if item.value %}
          <tr>
            <th style="width:240px;white-space:nowrap;">{{ item.label }}</th>
            <td>
              {% if item.is_dt %}
                {{ item.value|jalali_timedate }}
              {% elif item.is_money %}
                {{ item.value|format_price }}
              {% else %}
                {{ item.value }}
              {% endif %}
            </td>
          </tr>
          {% endif %}
        {% empty %}
          <tr>
            <td colspan="2" class="text-center text-muted">جزئیات دیگری ثبت نشده است.</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% if kind == 'environmental' %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
  (function () {
    // مختصات از شیء پیشنهاد (اگر موجود باشد)
    const latRaw = "{{ obj.media_location_latitude|default_if_none:'' }}";
    const lonRaw = "{{ obj.media_location_longitude|default_if_none:'' }}";
    const lat = parseFloat(latRaw);
    const lon = parseFloat(lonRaw);

    if (Number.isFinite(lat) && Number.isFinite(lon)) {
      const wrap = document.getElementById('env-map-wrap');
      if (wrap) wrap.style.display = '';

      const map = L.map('env-map', {
        center: [lat, lon],
        zoom: 14,
        zoomControl: true,
        dragging: true,           // اجازه جابه‌جایی نقشه (اختیاری)
        scrollWheelZoom: false,   // جلوگیری از اسکرول ناخواسته صفحه
        doubleClickZoom: true,
        boxZoom: false,
        keyboard: false
      });

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // مارکر فقط برای نمایش (غیرقابل‌کشیدن)
      L.marker([lat, lon], { draggable: false }).addTo(map);
    }
  })();
</script>
{% endif %}
{% endblock %}