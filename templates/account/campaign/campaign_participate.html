{% extends "account/account_base.html" %}
{% load static %}
{% load advplatform_tags %}
{% load account_tags %}
{% load humanize %}

{% block title %}شرکت در کمپین{% endblock %}

{% block extra_head %}
{% if ad_kind == "environmental" %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
  /* Map responsive and smaller */
  #env-map { height: 300px; width: 100%; border: 1px solid #ddd; border-radius: 6px; }
</style>
{% endif %}
<style>
   /* scrollable frame for content */
  .content-frame {
    max-height: calc(100vh - 140px);
    overflow-y: auto;
    overflow-x: hidden;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    background: #fff;
    padding: 1rem;
    -webkit-overflow-scrolling: touch;
  }
  @media (max-width: 576px) {
    .content-frame { max-height: calc(100vh - 110px); padding: .75rem; }
  }

  /* Left details stick on large screens */
  @media (min-width: 992px) {
    .campaign-details-sticky {
      position: sticky;
      top: 1rem;
    }
  }
  .campaign-cover {
    width: 100%;
    height: 140px;
    object-fit: cover;
    border-radius: 6px;
  }
  .thumb {
    width: 64px;
    height: 64px;
    object-fit: cover;
    border-radius: 6px;
    border: 1px solid #e5e5e5;
  }
  /* Dropzone styles (copied from campaigncreate) */
  .upload-dropzone { border:2px dashed #d1d5db; border-radius:10px; padding:16px; text-align:center; color:#6b7280; background:#f9fafb; margin-top:8px; }
  .preview-grid { display:flex; flex-wrap:wrap; gap:12px; margin-top:12px; }
  .preview-card { position:relative; width:150px; height:120px; border:1px solid #e5e7eb; border-radius:8px; background:#fff; overflow:hidden; display:flex; align-items:center; justify-content:center; }
  .preview-card img { max-width:100%; max-height:100%; object-fit:cover; }
  .preview-card .remove-btn { position:absolute; top:6px; right:6px; background:#ef4444; color:#fff; border:none; border-radius:6px; font-size:12px; padding:2px 6px; cursor:pointer; z-index:2; }
  .hidden { display:none !important; }
  .image-form input[type="checkbox"][name$="-DELETE"], .delete-checkbox { display:none !important; }
</style>
{% endblock %}

{% block content %}
<div class="content-frame">
  <div class="container mt-4">
    <h4 class="mb-3">شرکت در کمپین: {{ campaign.describe|default:"-" }}</h4>
  
    <div class="row g-4">
      
      <!-- Right column: form (smaller) -->
       {% if messages %}
          <div class="mb-3">
              {% for message in messages %}
                  <div class="alert alert-{{ message.tags }}">
                      {{ message }}
                  </div>
              {% endfor %}
          </div>
      {% endif %}
      <div class="col-12 col-lg-8 order-1 order-lg-2">
        {% if ad_kind == "environmental" %}
          <div class="alert alert-info">نوع پیشنهاد: تبلیغ محیطی</div>
        {% elif ad_kind == "socialmedia" %}
          <div class="alert alert-info">نوع پیشنهاد: تبلیغ شبکه‌های اجتماعی</div>
        {% elif ad_kind == "digital" %}
          <div class="alert alert-info">نوع پیشنهاد: تبلیغ دیجیتال</div>
        {% elif ad_kind == "printing" %}
          <div class="alert alert-info">نوع پیشنهاد: تبلیغ چاپی</div>
        {% elif ad_kind == "event" %}
          <div class="alert alert-info">نوع پیشنهاد: ایونت مارکتینگ</div>
        {% else %}
          <div class="alert alert-warning">نوع موضوع ناشناخته است. فرم عمومی ارسال می‌شود.</div>
        {% endif %}
      
        <form method="post" enctype="multipart/form-data" class="mt-3">
          {% csrf_token %}
        
          {% if ad_kind == "environmental" %}
            {{ form.non_field_errors }}
            {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
        
            {# fields except description and coords (coords set by map) #}
            <div class="row">
              {% for field in form.visible_fields %}
                {% if field.name != 'description' and field.name != 'media_location_latitude' and field.name != 'media_location_longitude' %}
                  <div class="col-12 col-md-6 mb-3">
                    <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                    {{ field }}
                    {{ field.errors }}
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          
            <h6 class="mt-2 mb-2">انتخاب موقعیت مکانی</h6>
            <div class="mb-2 d-flex gap-2 align-items-center">
              <button type="button" id="locateMeBtn" class="btn btn-sm btn-secondary">یافتن موقعیت من</button>
              <small class="text-muted">برای انتخاب موقعیت روی نقشه کلیک کنید.</small>
            </div>
            <div id="env-map" class="mb-2"></div>
            <div class="mb-3">
              <small id="coordsInfo" class="text-muted">مختصات انتخاب‌شده: -</small>
            </div>
          
            {% if form.description %}
            <div class="mb-3">
              <label for="{{ form.description.id_for_label }}" class="form-label">توضیحات</label>
              {{ form.description }}
              {{ form.description.errors }}
            </div>
            {% endif %}

            {# Environmental images dropzone (new) #}
            <div class="form-group mt-4">
              <label class="d-block mb-1">تصاویر موقعیت (حداقل یکی)</label>
              {% if image_formset %}
                {{ image_formset.management_form }}
                <div id="image-previews" class="preview-grid">
                  {% for f in image_formset.forms %}
                    <div class="image-form preview-card {% if not f.instance.pk or not f.instance.image %}hidden{% endif %}" data-index="{{ forloop.counter0 }}">
                      {{ f.id }}
                      <span class="delete-checkbox">{% if f.DELETE %}{{ f.DELETE }}{% endif %}</span>
                      {{ f.image }}
                      <button type="button" class="remove-btn {% if not f.instance.pk or not f.instance.image %}hidden{% endif %}">حذف</button>
                      {% if f.instance.pk and f.instance.image %}
                        <img src="{{ f.instance.image.url }}" alt="preview">
                      {% else %}
                        <img class="hidden" alt="preview">
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
                <div class="upload-dropzone" id="upload-dropzone">
                  <div>برای افزودن تصویر کلیک کنید یا دکمه زیر را بزنید</div>
                  <button type="button" id="add-image-form" class="btn btn-sm btn-outline-primary">افزودن تصویر</button>
                </div>
                <div id="empty-form" class="hidden">
                  {{ image_formset.empty_form.id }}
                  <span class="delete-checkbox">{% if image_formset.can_delete %}{{ image_formset.empty_form.DELETE }}{% endif %}</span>
                  {{ image_formset.empty_form.image }}
                </div>
              {% endif %}
            </div>
          {% else %}
            <div class="card">
              <div class="card-body">
                {{ form.as_p }}
              </div>
            </div>
          {% endif %}
          
          <div class="mt-3">
            <button type="submit" class="btn btn-primary">ارسال پیشنهاد</button>
            <a href="{% url 'account:campaigns' %}" class="btn btn-secondary">بازگشت</a>
          </div>
        </form>
      </div>
    
      <!-- Left column: campaign details -->
      <div class="col-12 col-lg-4 order-2 order-lg-1">
        <div class="card campaign-details-sticky">
          <div class="card-body">
            <h5 class="card-title mb-3">جزئیات کمپین</h5>
          
            {% with cover=campaign.campaignsimages.all|first %}
            {% if cover %}
              <img src="{{ cover.image.url }}" alt="campaign image" class="campaign-cover mb-3">
            {% endif %}
            {% endwith %}
          
            <div class="mb-2">
              <span class="text-muted">موضوعات:</span>
              <div class="mt-1">
                {% for t in campaign.topic.all %}
                  <span class="badge bg-secondary me-1 mb-1">{{ t.name }}</span>
                {% empty %}
                  <span class="text-muted">—</span>
                {% endfor %}
              </div>
            </div>
          
            <div class="mb-2">
              <span class="text-muted">کارفرما:</span>
              <div class="mt-1">{{ campaign.customer.get_full_name|default:campaign.customer.email }}</div>
            </div>
          
            <div class="mb-2">
              <span class="text-muted">بودجه پیشنهادی:</span>
              <div class="mt-1">{{ campaign.purposed_price|format_price }} </div>
            </div>
          
            <div class="mb-2">
              <span class="text-muted">وضعیت:</span>
              <div class="mt-1">
                {{ campaign.get_status_display|default:campaign.status }}
                {% if campaign.is_active %}
                  <span class="badge bg-success me-1">فعال</span>
                {% else %}
                  <span class="badge bg-secondary me-1">غیرفعال</span>
                {% endif %}
              </div>
            </div>
          
            <div class="mb-2">
              <span class="text-muted">زمان شروع:</span>
              <div class="mt-1">{{ campaign.starttimedate|date:"Y-m-d H:i"|default:"—" }}</div>
            </div>
          
            <div class="mb-2">
              <span class="text-muted">زمان پایان:</span>
              <div class="mt-1">{{ campaign.endtimedate|date:"Y-m-d H:i"|default:"—" }}</div>
            </div>
          
            <div class="mb-3">
              <span class="text-muted d-block">توضیحات:</span>
              <div class="small mt-1" style="white-space: pre-wrap">{{ campaign.describe| default:"—" }}</div>
            </div>
          
            {% with imgs=campaign.campaignsimages.all %}
            {% if imgs %}
              <div class="mb-2">
                <span class="text-muted d-block mb-2">تصاویر:</span>
                <div class="d-flex flex-wrap gap-2">
                  {% for img in imgs %}
                    <img class="thumb" src="{{ img.image.url }}" alt="campaign image {{ forloop.counter }}">
                  {% endfor %}
                </div>
              </div>
            {% endif %}
            {% endwith %}
          </div>
        </div>
      </div>
    
    </div>
  </div>
</div>

{% if ad_kind == "environmental" %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
  (function () {
    // coords
    const latInput = document.getElementById('id_media_location_latitude');
    const lonInput = document.getElementById('id_media_location_longitude');
    const coordsInfo = document.getElementById('coordsInfo');

    // province/city
    const provinceSelect = document.getElementById('id_province');
    const citySelect = document.getElementById('id_city');

    async function loadCities(provinceId, selectedId) {
      if (!citySelect) return;
      citySelect.innerHTML = '';
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'انتخاب شهر';
      citySelect.appendChild(opt);

      if (!provinceId) return;

      try {
        const resp = await fetch("{% url 'account:ajax_cities' %}?province_id=" + encodeURIComponent(provinceId));
        const data = await resp.json();
        (data.results || []).forEach(function (c) {
          const o = document.createElement('option');
          o.value = c.id;
          o.textContent = c.name;
          if (selectedId && String(selectedId) === String(c.id)) o.selected = true;
          citySelect.appendChild(o);
        });
      } catch (e) {
        console.error(e);
      }
    }

    if (provinceSelect && citySelect) {
      const initialProvince = provinceSelect.value;
      const initialCity = citySelect.getAttribute('value') || citySelect.value || '';
      if (initialProvince) {
        loadCities(initialProvince, initialCity);
      }
      provinceSelect.addEventListener('change', function () {
        loadCities(this.value, '');
      });
    }

    // map
    let initLat = parseFloat(latInput?.value) || 35.6892;
    let initLon = parseFloat(lonInput?.value) || 51.3890;
    let initZoom = (latInput?.value && lonInput?.value) ? 14 : 6;

    const map = L.map('env-map', { center: [initLat, initLon], zoom: initZoom });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let marker = L.marker([initLat, initLon], { draggable: true }).addTo(map);

    function updateInputs(latlng) {
      if (!latInput || !lonInput) return;
      latInput.value = latlng.lat.toFixed(6);
      lonInput.value = latlng.lng.toFixed(6);
      if (coordsInfo) coordsInfo.textContent = `مختصات انتخاب‌شده: ${latInput.value}, ${lonInput.value}`;
    }
    updateInputs({ lat: initLat, lng: initLon });

    map.on('click', function (e) { marker.setLatLng(e.latlng); updateInputs(e.latlng); });
    marker.on('dragend', function (e) { updateInputs(e.target.getLatLng()); });

    const locateBtn = document.getElementById('locateMeBtn');
    if (locateBtn && navigator.geolocation) {
      locateBtn.addEventListener('click', function () {
        navigator.geolocation.getCurrentPosition(function (pos) {
          const ll = L.latLng(pos.coords.latitude, pos.coords.longitude);
          map.setView(ll, 15); marker.setLatLng(ll); updateInputs(ll);
        }, function () { alert('امکان دریافت موقعیت شما وجود ندارد.'); }, { enableHighAccuracy: true, timeout: 8000 });
      });
    }
  })();
</script>
{% endif %}

{# province/city JS for other kinds if needed #}
{% if ad_kind == "event" or ad_kind == "socialmedia" or ad_kind == "digital" or ad_kind == "printing" %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const provinceSelect = document.getElementById('id_province');
  const citySelect = document.getElementById('id_city');
  if (!provinceSelect || !citySelect) return;

  provinceSelect.addEventListener('change', function () {
    const pid = this.value;
    citySelect.innerHTML = '<option value="">در حال بارگذاری...</option>';
    if (!pid) {
      citySelect.innerHTML = '<option value="">ابتدا استان را انتخاب کنید</option>';
      return;
    }

    fetch("{% url 'account:ajax_cities' %}?province_id=" + encodeURIComponent(pid))
      .then(r => r.json())
      .then(data => {
        citySelect.innerHTML = '<option value="">انتخاب شهر</option>';
        (data.results || []).forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.id;
          opt.textContent = c.name;
          citySelect.appendChild(opt);
        });
      })
      .catch(() => {
        citySelect.innerHTML = '<option value="">خطا در بارگذاری</option>';
      });
  });
});
</script>
{% endif %}

{% if ad_kind == "environmental" %}
<script>
// Environmental images dropzone logic (mirrors campaign create)
document.addEventListener('DOMContentLoaded', function(){
  const previews = document.getElementById('image-previews');
  if(!previews) return;
  const dropzone = document.getElementById('upload-dropzone');
  const addBtn   = document.getElementById('add-image-form');
  const emptyForm= document.getElementById('empty-form');
  const totalForms = document.getElementById('id_{{ image_formset.prefix }}-TOTAL_FORMS');

  Array.from(previews.querySelectorAll('.image-form')).forEach(card => {
    const fileInput = card.querySelector('input[type="file"]');
    const img = card.querySelector('img');
    const removeBtn = card.querySelector('.remove-btn');
    const deleteField = card.querySelector('input[name$="-DELETE"]');
    const idField = card.querySelector('input[name$="-id"]');
    if(!(idField && idField.value)) { card.classList.add('hidden'); if(removeBtn) removeBtn.classList.add('hidden'); }
    if(fileInput){
      fileInput.addEventListener('change', e => {
        const file = e.target.files && e.target.files[0];
        if(file){ const reader=new FileReader(); reader.onload=()=>{ img.src=reader.result; img.classList.remove('hidden'); removeBtn.classList.remove('hidden'); }; reader.readAsDataURL(file);} else { img.src=''; img.classList.add('hidden'); if(!(idField && idField.value)) card.classList.add('hidden'); }
      });
    }
    if(removeBtn){
      removeBtn.addEventListener('click', ()=>{ if(idField && idField.value && deleteField){ deleteField.checked=true; card.classList.add('hidden'); } else { if(fileInput) fileInput.value=''; img.src=''; img.classList.add('hidden'); removeBtn.classList.add('hidden'); card.classList.add('hidden'); } });
    }
  });

  function addNewImageCard(){
    const nextIndex = parseInt(totalForms.value,10) || 0;
    const html = emptyForm.innerHTML.replace(/__prefix__/g,String(nextIndex));
    const wrap = document.createElement('div');
    wrap.className='image-form preview-card';
    wrap.dataset.index=String(nextIndex);
    wrap.innerHTML = html + '<button type="button" class="remove-btn hidden">حذف</button><img class="hidden" alt="preview">';
    const fileInput = wrap.querySelector('input[type="file"]');
    const img = wrap.querySelector('img');
    const removeBtn = wrap.querySelector('.remove-btn');
    const deleteField = wrap.querySelector('input[name$="-DELETE"]');
    fileInput.addEventListener('change', e => { const file=e.target.files && e.target.files[0]; if(file){ const reader=new FileReader(); reader.onload=()=>{ img.src=reader.result; img.classList.remove('hidden'); removeBtn.classList.remove('hidden'); totalForms.value=String(nextIndex+1); }; reader.readAsDataURL(file);} else { wrap.remove(); }});
    removeBtn.addEventListener('click', ()=>{ if(deleteField){ deleteField.checked=true; } wrap.remove(); });
    previews.appendChild(wrap); fileInput.click();
  }
  if(addBtn){ addBtn.addEventListener('click', e=>{ e.stopPropagation(); addNewImageCard(); }); }
  if(dropzone){ dropzone.addEventListener('click', ()=> addNewImageCard()); }
});
</script>
{% endif %}
{% endblock %}

