{% extends "account/account_base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% load account_tags %}


{% block title %}پروفایل کاربری{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'account/vendors/persian-datepicker/persian-datepicker.min.css' %}">
<style>
  .pdp-default { z-index: 999999; }
</style>
{% endblock %}

{% block content %}
<style>
  [dir="rtl"] .form-row { direction: rtl; }
  textarea.form-control { min-height: 80px; }
  .input-help { font-size: 12px; color: #6c757d; }
  .dropzone {
    border: 2px dashed #cbd5e0;
    border-radius: 8px;
    background: #f8fafc;
    color: #1449b4ff;
    height: 260px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: .2s border-color, .2s background;
    text-align: center;
    font-size: medium;
    min-height:240px; border:2px dashed #cbd5e1; border-radius:12px;
    background:#f8fafc; cursor:pointer; user-select:none;
  }
  .dropzone.dragover { border-color: #28a745; background: #f0fff4; }
  .dropzone .placeholder { pointer-events: none; }
  .dropzone .placeholder .plus {
    font-size: 42px; font-weight: 700; line-height: 1; display: block; margin-bottom: 10px; color: #9ca3af;
  }
  .dropzone img.preview {
    max-height: 100%; max-width: 100%; object-fit: contain; border-radius: 6px; display: none;
  }
  .btn-success { background-color: #28a745; border-color: #28a745; }
  .btn-success:hover { background-color: #218838; border-color: #1e7e34; }
  .my-custom-p{ font-size: 13px; color: #1619ca; }

  /* star rating (supports fractional fill) */
  .rating{ display:inline-flex; align-items:center; gap:8px; }
  .rating-stars{ position:relative; display:inline-block; font-size:22px; line-height:1; }
  .rating-stars .stars-outer{ color:#e5e7eb; }      /* empty (off) */
  .rating-stars .stars-inner{
    position:absolute; left:0; top:0; white-space:nowrap; overflow:hidden;
    color:#f59e0b; width:0;                              /* filled (on) */
  }
.sr-only{
    position:absolute; width:1px; height:1px; padding:0; margin:-1px;
    overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
  }
.my-span-custom{
font-size: 14px; color: #f40cd1ff;
}
</style>

<div class="col-md-12" dir="rtl">
  <div class="x_panel" style="scale:85%;">
    <div class="x_title">
      <h2>پروفایل کاربری</h2>
      <div class="clearfix"></div>
    </div>

    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}

      <div class="col-md-12 col-sm-12 col-xs-12">

        <div class="form-row">
          <div class="form-group col-md-6 mb-0">
            {{ form.username|as_crispy_field }}
          </div>
          <div class="form-group col-md-6 mb-0">
            {{ form.email|as_crispy_field }}
          </div>
        </div>

        {% if user.cutomer_type == 'private' or user.cutomer_type is None %}
          <div class="form-row">
            <div class="form-group col-md-6 mb-0">
              {{ form.first_name|as_crispy_field }}
            </div>
            <div class="form-group col-md-6 mb-0">
              {{ form.last_name|as_crispy_field }}
            </div>
          </div>
        {% elif user.cutomer_type == 'juridical' %}
          <div class="form-row">
            <div class="form-group col-md-6 mb-0">
              {{ form.company_name|as_crispy_field }}
            </div>
          </div>
        {% endif %}

        <div class="form-row">
          {% if form.phone_number %}
            <div class="form-group col-md-6 mb-0">
              {{ form.phone_number|as_crispy_field }}
            </div>
          {% endif %}
          {% if form.birth_date %}
            <div class="form-group col-md-6 mb-0">
              {# datepicker will be attached via JS #}
              {{ form.birth_date|as_crispy_field }}
            </div>
          {% endif %}
        </div>

        <div class="form-row">
          <div class="form-group col-md-12 mb-0" style="border-radius: 6px;">
            {{ form.address|as_crispy_field }}
          </div>
        </div>

        {% if not user.is_staff %}
          <div class="form-row">
            <div class="form-group col-md-4 mb-0">
              <label>نوع کاربر:</label>
              <p class="my-custom-p" style="display: inline;">{{ user.get_user_type_display }}</p>
            </div>
          </div>
        {% endif %}

        {% if user.user_type == 'customer' or user.user_type == 'dealer' %}
          <div class="form-row">
            <div class="form-group col-md-6 mb-0">
              <label>نوع مشتری:</label>
              <p class="my-custom-p" style="display: inline;">{{ user.get_cutomer_type_display }}</p>
            </div>
          </div>
        {% endif %}

        {% if user.user_type == 'dealer' or user.user_type == 'mentor' %}
          <div class="form-row" style="margin-top:10px;">
            <div class="form-group col-md-3 mb-0">
              <label>امتیاز شما:</label>
              {% if user.rank %}
                <div id="user-rating" class="rating" data-value="{{ user.rank }}" data-max="5" title="امتیاز {{ user.rank }} از 5">
                  <div class="rating-stars" aria-hidden="true">
                    <div class="stars-outer">★★★★★</div>
                    <div class="stars-inner">★★★★★</div>
                  </div>
                </div>
              {% else %}
                <p class="my-custom-p" style="display: inline;">فعلا امتیازی ندارید</p>
              {% endif %}
            </div>
            {% if user.speciality_field %}
              <div class="form-group col-md-6 mb-0">
                {{ form.speciality_field }}
              </div>
            {% endif %}
          </div>
        {% endif %}
          <hr>
        <div class="form-row" style="margin-top:10px;">
          <div class="form-group col-md-12">
            <label class="mb-2">تصویر آواتار</label>
            <div id="dropzone" class="dropzone">
              {% with user.customuserimages.last as profile_image %}
                <img id="dz-preview" class="preview"
                     src="{% if profile_image %}{{ profile_image.image.url }}{% else %}{% static 'images/default-profile.png' %}{% endif %}"
                     alt="جهت درج تصویر کلیک کنید">
              {% endwith %}
             
            </div>
            <input type="file" name="profile_image" id="profile_image" accept="image/*" class="sr-only">
            <div class="input-help mt-2" id="file-name"></div>
          </div>
        </div>

        <div class="form-row" style="margin: 10px 0;">
          <div class="col-md-12">
            <a href="{% url 'account:home' %}" class="btn btn-default">انصراف</a>
            <button type="submit" class="btn btn-success">ذخیره تغییرات</button>
            <span class="my-span-custom" style="margin-right:30px;">
              برای تغییر گذرواژه <a href="{% url 'account:password_change' %}" style="color: #0945ecff;">کلیک</a> کنید
            </span>
          </div>
        </div>

      </div>
    </form>
  </div>
</div>

<script>
  (function () {
    const dz = document.getElementById('dropzone');
    const input = document.getElementById('profile_image');
    const preview = document.getElementById('dz-preview');
    const placeholder = document.getElementById('dz-placeholder');
    const fileName = document.getElementById('file-name');

    function showPreview(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        preview.src = e.target.result;
        preview.style.display = 'block';

        if (placeholder) placeholder.style.display = 'none';
        fileName.textContent = file.name;
      };
      reader.readAsDataURL(file);
    }

    if (dz && input) {
      dz.addEventListener('click', () => input.click());
      input.addEventListener('change', e => showPreview(e.target.files[0]));
      dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragover'); });
      dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
      dz.addEventListener('drop', e => {
        e.preventDefault(); dz.classList.remove('dragover');
        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
          input.files = e.dataTransfer.files;
          showPreview(e.dataTransfer.files[0]);
        }
      });
    }

    if (preview && preview.getAttribute('src')) {
      preview.style.display = 'block';
      if (placeholder) placeholder.style.display = 'none';
    }

    /* fractional star fill */
    const ratingEl = document.getElementById('user-rating');
    if (ratingEl) {
      const value = parseFloat(ratingEl.dataset.value || '0');
      const max = parseFloat(ratingEl.dataset.max || '5');
      const percent = Math.max(0, Math.min(100, (value / max) * 100));
      const inner = ratingEl.querySelector('.stars-inner');
      if (inner) inner.style.width = percent + '%';
    }
  })();
</script>
{% endblock %}

{% block extra_js %}
<script src="{% static 'account/vendors/persian-datepicker/persian-date.min.js' %}"></script>
<script src="{% static 'account/vendors/persian-datepicker/persian-datepicker.min.js' %}"></script>
<script>
  (function() {
    // Attach Persian datepicker to birth_date and submit Gregorian to backend
    var $birth = $('#id_birth_date');
    if ($birth.length) {
      // Ensure input is text for the datepicker to work
      $birth.attr('type', 'text')
            .addClass('persian-datepicker')
            .attr('autocomplete', 'off');

      $birth.persianDatepicker({
        format: 'YYYY/MM/DD',
        initialValue: false,
        autoClose: true,
        timePicker: { enabled: false },
        onSelect: function(unix) {
          var date = new persianDate(unix);
          var gregorianDate = date.toCalendar('gregorian').toLocale('en').format('YYYY-MM-DD');
          $(this.model.input.elem).val(gregorianDate);
        }
      });
    }
  })();
</script>
{% endblock %}

